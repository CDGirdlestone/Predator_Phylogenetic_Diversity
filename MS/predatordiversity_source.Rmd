%Predator phylogenetic diversity decreases predation rate via antagonistic interactions
%A. Andrew M. MacDonald, Diane S. Srivastava, Gustavo Q. Romero

```{r options_packages_data, message=FALSE, echo=FALSE}
## set chunk options
opts_chunk$set(message=FALSE,warning=FALSE,echo=FALSE,fig.cap=FALSE)

## load packages
library(ggplot2)
library(bipartite)
library(reshape2)
library(vegan)
library(picante)
library(beanplot)
library(pander)
library(gplots)
library(plyr)

# occurrance data -- abundance
occur <- read.csv("~/Dropbox/PhD/Brazil2011/data/reorganized_data/predator.cooccur.txt",
                  stringsAsFactor=FALSE)
# occurrance data -- metabolic capacity
metabolic  <- read.csv("~/Dropbox/PhD/Brazil2011/data/reorganized_data/predator.cooccur.metabolic.txt",
                       stringsAsFactor=FALSE)
# feeding trial data
foodweb <- read.csv("~/Dropbox/PhD/Brazil2011/data/reorganized_data/reorganized.feeding.trial.data.csv",
                    stringsAsFactors=FALSE)
# experimental data
pd <- read.csv("../data/reorganized_data/pd_exp_cleaned_data.csv",stringsAsFactors=FALSE)
# enriched leaves -- ie just the N data for the detritus we put in.
enriched <- read.csv("../data/reorganized_data/enriched_leaves.csv",stringsAsFactors=FALSE)
# phylogeny data
predtree_timetree_ages <- read.tree("../data/reorganized_data/predator_tree_time.newick")

## load in functions
source("../R.scripts/FUNCTIONS_predator_diversity.R")

#source("../R.scripts/cleanup_organization_for_graphing_analysis.R")
```

```{r experiment_data_postprocess}
#dropping a record that seems to have been 90% decomposed!
pd[which(pd$decomp>0.7),'decomp'] <- NA
## just to make sure:
with(pd,table(treatment))
head(pd)

```

## Introduction


<!-- 
Predators are present in most ecosystems, and are important functional groups in determining ecosystem function.  While predator-prey relationships have been studied for a long time, we understand little of the effects of predator diversity on whole communites and ecosystems.  Phylogenetic diversity of plants may correlates well with community level variables, but as yet studies of predator combinations rarely use measures of predator phylogenetic diversity.  In our study we present results from patterns of predator co-occurance, feeding trials, finally a community-level experiment in which we directly manipulated phylogenetic diversity of predators.  In each we ask if the phylogenetic distance between predators is related to similarity, or if diversity is correlated with effect on ecosystem function
.
Decreasing predator richness has been shown to increase herbivory [@Byrnes2006] in a three-level kelp food web.  As these authors point out, the effect of diversity on ecosystem functioning is better known for lower tropic levels, rather than predators.   
Predator combinations can have many different outcomes.  From the perspective of ecosystem function it is important to consider whether these result in more or less top-down control.  Predator effects can be direct via changes in consumption, indirect via non-consumptive effects.  in other words, it can be via the effects of predators on each other, or on their prey, and directly or indirectly.  Therefore, in our experiment we tracked both predator and prey survival to the end of the experiment

for example, predators can kill each other, or decrease feeding rates. 
-->

We test three related hypotheses: 

1. *species co-occurance*: closely-related predators occur together more frequently than less-related predators, due to their similar habitat requirements.  Additionally, very closely related species never co-occur because they are  too similar.

2. *diet similarity*: similarity in diet (as measured by feeding trials) decreases with phylogenetic distance.

3. *ecosystem-level effects*: similarity in the effect of predators on whole ecosystems declines with phylogenetic distance.  Additionally, the non-additive effect of predators will have a greater absolute value when their phylogenetic diversity is larger.


## Methods

<!-- 
We combined predators together in species pairs that represented a
range of relatedness: congeners (two congeneric damselflies,
*Leptagrion andromache* and *Leptagrion elongatum*), two
insects (a damselfly, *L. elongatum* and a predatory fly
(Diptera: Tabanidae)) and two invertebrates (*L. elongatum* and
leeches).  We also included these four species in monoculture, along
with a predator-free control (8 treatments, n=5).  Combinations were
substitutive, maintaining the same amount of predator metabolic
capacity (biomass raised to the power of 0.69, predicting the scaling
of metabolism with body mass [@Brown2004]) in each.  Response
variables included the rate of decomposition of leaves, bromeliad
growth and insect emergence.  This experiment allows the estimation of
the effect of each predator species from monoculture treatments, as
well as the detection of non-additive effects in predator
combinations. 

In Feburary 2011, bromeliads between 90 and 200ml were collected,
thoroughly washed and soaked for 12 hours in a tub of water.  They
were then hung for 48 hours to dry.  One bromeliad dissected after
this procedure contained no insects.

Each bromeliad was supplied with dried leaves, simulating natural
detritus inputs from the canopy.  We enriched these leaves with N-15
by fertilizing five (Jabuticaba, *Plinia cauliflora*) plants with
40ml/pot/day of 5g/L ammonium sulphate containing 10 percent atom
excess of N15. *duration*. started on 27/1/2011
Whole leaves were then picked from plants and air-dried until constant
weight, and then soaked for three days and the water discarded.  About
1.5 g of leaves were placed in each bromeliad (`r mean(pd$mass.g.)` Â± `r sd(pd$mass.g.)`). 

Each bromeliad was stocked with a representative insect community.
The densities of each prey taxon were calculated from a 2008
observational dataset, using data from bromeliads of similar size to
those in our experiment (DS Srivastava, upub. data).  All densities
used were within the range of these calculated abundances, and all
experimental bromeliads received the same insect community.  Halfway
through the experiment, insects were added to bromeliads a second
time.

\begin{table}
  \centering
  \caption{densities of each species}
  \label{tab:sppden}
  \begin{tabular}{l l}
    \hline
    \emph{Chironomus detriticula} & 10 \\
    \emph{Polypedium} sp. 1 & 4 \\
    \emph{Polypedium} sp. 2 & 2 \\
    \emph{Psychodid} sp. 1 & 1 \\
    \emph{Scyrtes} sp. A & 5 \\
    \emph{Culex} spp. & 4 \\
    \emph{Trentepholia} sp. & 1
  \end{tabular}
\end{table}

After addition of the prey community, all bromeliads were enclosed
with a mesh cage and checked daily for emergence of adults. 

-->

<!-- Our central hypothesis is that the phylogenetic relationships among predatory taxa in this system can be used to interpret their ecology.  Specifically, we test the hypothesis that phylogenetic relatedness is negatively correlated with probability of co-occurance, positively with diet similarity.  Consequently, we might predict that ecosystem function peaks at some intermediate level of phylogenetic diversity -- where predators occur but where their similarity creates complementarity. -->

## Results

### metabolic capacity and phylogenetic distance

```{r distance_matrix_calculation}

## combine by names, then do distances:
## metabolic matrix
metabolic.matrix <- metabolic[-1]
dimnames(metabolic.matrix)[[1]] <- metabolic[,1]
pred.abd.distance <- vegdist(metabolic.matrix,method="euclid")
pred_abd_matrix <- as.matrix(pred.abd.distance)
#occurdist_allpred <- data.frame(X=rownames(pred_abd_matrix),pred_abd_matrix)
metabolic_mat <- as.matrix(metabolic.matrix)
# reordered metabolic distance matrix
pred_cor_occurance_metabolic <- cor(t(metabolic_mat))

####### phylogeny matrix ####
## Calculate distances
allpred.distance.matrix <- cophenetic(predtree_timetree_ages)
## match to abundance matrix names
where_in_phylo <- match(rownames(pred_abd_matrix),rownames(allpred.distance.matrix))
## reorder phylogenetic distance matrix
pred_phylo_matrix <- allpred.distance.matrix[where_in_phylo,where_in_phylo]

#Xlab <- expression(paste("Phylogenetic distance (mean age of common ancestor,10"^"6",")"))
#### #### 
```

```{r experiment-randomization-test}
### ---- group means ####
##go2 <- responses.means(1000)
#write.csv(go2,"randomizations.group.means.csv")
rand.means <- read.csv("../data/predator.div.experiment/randomizations.group.means.csv")
## order these correctly
rand.means$sp.pair <- factor(rand.means$sp.pair,
                             levels=c('elong + andro','elong + tab',
                               'elong + leech')
                             )
## remove the X column
rand.means <- rand.means[,-1]

### supplementary figure?  ####
meansMelt <- melt(rand.means)
# #densityplot(~growth+survival+fine+decomp,groups=sp.pair,data=go)
# ggplot(data=meansMelt,aes(x=value,colour=sp.pair))+geom_histogram()+facet_wrap(~variable)

## summarize the randomizations 
summarize_randoms <- ddply(.data=meansMelt,.variables=.(sp.pair,variable),summarize,
                       mean=mean(value),lower=quantile(value,probs=c(0.025)),
                       upper=quantile(value,probs=c(0.975))
                       )
```


```{r test_metabolic~phylo,results='asis'}
PD <- pred_phylo_matrix[lower.tri(pred_phylo_matrix)]
occurance_phylo_lm <- lm(pred_cor_occurance_metabolic[lower.tri(pred_cor_occurance_metabolic)]~PD)
occur_phylo_summary <- summary(occurance_phylo_lm)
#mantel.test(pred_phylo_matrix,pred_cor_matrix)
```

Predators which are closer in the phylogeny are more likely to occur in the same bromeliads, and to do so with a similar overall metabolic capacity.(F~`r occur_phylo_summary$fstatistic[["numdf"]]`,`r occur_phylo_summary$fstatistic[["dendf"]]`~=`r occur_phylo_summary$fstatistic[["value"]]`,P=`r pf(occur_phylo_summary$fstatistic[1],occur_phylo_summary$fstatistic[2],occur_phylo_summary$fstatistic[3],lower.tail=FALSE)`).

### diet similarity and phylogenetic distance
```{r diet_similarity_calculation}
# Check for TRUE ZEROS in cast matrix.

# trial.list <- split(foodweb,foodweb$predator.names)
# sapply(trial.list,nrow)
## need predators as columns, herbivores as rows
foodweb.cast <- dcast(data=foodweb,formula=Prey.species~predator.names,value.var="eaten.numeric",fun.aggregate=sum)
# remove species names
foodweb.matrix <- as.matrix(foodweb.cast[,-1])
# have better names
dimnames(foodweb.matrix) <- list(foodweb.cast[[1]],names(foodweb.cast)[-1])
foodweb.matrix <- foodweb.matrix[,-ncol(foodweb.matrix)]  ## last column was an NA predator.
# make the distance matrix -- with the jaccard index?
## start by getting the predators from the foodweb data that are actually in the experiment:
location_exp_predators <- which(dimnames(foodweb.matrix)[[2]]%in%c("Tabanidae.spA","Hirudinidae","Leptagrion.andromache","Leptagrion.elongatum"))
## vegdist will calculate differences among rows, so transpose
experiment_predators_diet <- t(foodweb.matrix[,location_exp_predators])
## better to rename and reorder to resemble output of cophenetic
## phylogenetic distances:
predators.in.exp <- prune_predators()
phylodist <- cophenetic(predators.in.exp)
## they should also be in the same sequence:
experiment_pred_diet_reordered <- experiment_predators_diet[match(rownames(experiment_predators_diet),rownames(phylodist)),]
## finally, calculate distance
distances <- vegdist(experiment_pred_diet_reordered,method='jaccard',diag=TRUE)
## make a distance matrix so lower.tri subsetting works
dist.mat <- as.matrix(distances)

```

```{r TEST_diet-sim~PD}
PD <- phylodist[lower.tri(phylodist)]
diet_sim_phylo <- lm(dist.mat[lower.tri(dist.mat)]~PD)
diet_phylo_summary <- summary(diet_sim_phylo)
```

Phylogenetic distance was not correlated with similarity in diet (F~`r diet_phylo_summary$fstatistic[["numdf"]]`,`r diet_phylo_summary$fstatistic[["dendf"]]`~=`r diet_phylo_summary$fstatistic[["value"]]`,P=`r pf(diet_phylo_summary$fstatistic[1],diet_phylo_summary$fstatistic[2],diet_phylo_summary$fstatistic[3],lower.tail=FALSE)`).  Indeed, all predators in this system appeared to feed readily on a wide range of prey species.

### Ecosystem-level effects and phylogenetic distance

All increases in predator phylogenetic diversity beyond damselflies resulted in a reduction of prey mortality.



### Figures

```{r metabolic_cap_fig}
plot(pred_abd_matrix[lower.tri(pred_abd_matrix)]~
       jitter(pred_phylo_matrix[lower.tri(pred_phylo_matrix)],amount=5),
     xlab="phylogenetic distance",ylab="euclidian distance between total metabolic capacity")
```


```{r feeding_trial}
plot(dist.mat[lower.tri(dist.mat)]~
       jitter(phylodist[lower.tri(phylodist)],amount=10),
     xlab="phylogenetic distance",ylab="jaccard distance between feeding trials")
```

```{r FIG_PD_experiment}
# distances of L. elongatum to everything:
Le_distances <- sort(phylodist["Leptagrion.elongatum",])
lkup <- data.frame(sp.pair=levels(summarize_randoms$sp.pair),Time=Le_distances[-1])
summarize_randoms_phylo <- merge(summarize_randoms,lkup)
ggplot(subset(summarize_randoms_phylo,summarize_randoms_phylo$variable=="survival"),
       aes(x=Time,y=mean))+geom_errorbar(aes(ymin=lower, ymax=upper),width=0)+geom_point(size=3)+ylab("Mean treatment difference, Control-Treatment")+xlab("Time (Mya)")
```





## Discussion



## Works Cited