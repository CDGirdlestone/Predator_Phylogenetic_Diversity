---
title: "Predator phylogenetic diversity decreases predation rate via antagonistic interactions"
author: "Andrew MacDonald; Diane S. Srivastava; Gustavo Q. Romero"
output:
  html_document: default
  md_document: default
  pdf_document: default
  word_document:
    reference_docx: reference.docx
bibliography: /home/andrew/Documents/Mendeley_reference_lists/@MS_pdpaper.bib
---

```{r options_packages_data, message=FALSE, echo=FALSE}
## set chunk options
library(knitr)
opts_chunk$set(message=FALSE,warning=FALSE,echo=FALSE,fig.cap=FALSE,dev="png")

## load packages
library(ggplot2)
mytheme <- theme_bw()
library(bipartite)
library(reshape2)
library(vegan)
library(picante)
library(pander)
library(gplots)
#library(plyr)
library(gridExtra)
library(dplyr)
library(magrittr)
library(xtable)
library(stargazer)
library(tidyr)

# occurrance data -- abundance
occur <- read.csv("../data/reorganized_data/predator.cooccur.txt",
                  stringsAsFactor=FALSE) %>%
  tbl_df()
# occurrance data -- metabolic capacity
metabolic  <- read.csv("../data/reorganized_data/predator.cooccur.metabolic.txt",
                       stringsAsFactor=FALSE) %>%
  tbl_df()
# feeding trial data
feeding_trials <- read.csv("../data/reorganized_data/reorganized.feeding.trial.data.csv",
                    stringsAsFactors=FALSE) %>%
  tbl_df()
# experimental data
pd <- read.csv("../data/reorganized_data/pd_exp_cleaned_data.csv",
               stringsAsFactors=FALSE) %>%
  tbl_df()
# enriched leaves -- ie just the N data for the detritus we put in.
enriched <- read.csv("../data/reorganized_data/enriched_leaves.csv",
                     stringsAsFactors=FALSE) %>%
  tbl_df()
# phylogeny data
predtree_timetree_ages <- read.tree("../data/reorganized_data/predator_tree_time.newick")
# randomization tests
rand.means <- read.csv("../data/predator.div.experiment/randomizations.group.means.csv") %>%
  tbl_df()

## load in functions
source("../R.scripts/FUNCTIONS_predator_diversity.R")

#source("../R.scripts/cleanup_organization_for_graphing_analysis.R")
```

```{r experiment_data_postprocess}
#dropping a record that seems to have been 90% decomposed!
pd <- pd %>%
  transform(decomp=ifelse(decomp>0.7,NA,decomp))
```

## Introduction

Predator assemblages can have strong top-down effects, both on community
structure and ecosystem processes [@Estes2011].  The strength of these effects is often dependent on species composition, and can be more or less than what simply the sum of effect sizes of individual predators [@Sih1998a;@Ives2005]. Detailed studies manipulating
predator assemblages have identified a great diversity of direct and indirect mechanisms underlying the effect of predator diversity on communities. For example, predators differ in their prefernces for microhabitats resulting in spatial or temporal partitioning between predator species in their effects on prey and synergistic effects on net predation rates [@Schmitz2007].  When predators do
co-occur in a local patch, they may feed on different prey species and so have additie top-down effects [@Schmitz2007]. Conversely, antagonistic predator-predator interactions can reduce the top-down effects of a diverse
consumer assemblage, for example when predators feed directly on each other (intra-guild
predation) or modify the behaviour of predators or prey via non-consumptive
(ie trait-mediated) interactions [@Sih1998a;@Griswold2006;@Nystrom2001].  While
there are many mechanisms potentially underlying predator compositional effects, we lack a means of predicting _a priori_ which combinations are likely to have antagonistic versus synergistic effects on ecosystem functions. 

Several authors have hypothesized that the
phylogenetic diversity of a community or assemblage may correlate with increased
ecosystem function, via increases in trait diversity [@Srivastava2012c].
<!-- Cadotte et al. many, cavender-Bares ecol let review, Flynn et al., Mahereli and Klironomos, -->

Phylogenetic diversity measures have provided useful insights into diverse plant
communities [e.g. @Cadotte2009;@Cadotte2008;@Godoy2014], and yet have rarely been
applied to local assemblages of predators [@Bersier2008;@Naisbit2011]. Many
studies of phylogenetic signal in predator traits focus on whole clades, rather
than local assemblages (e.g. *Anolis* lizards [@Knouft2006], warbler [@Bohning-Gaese2003], treeboas [@Henderson2013] and wasps [@Udriene2005]) making it
difficult to connect these results to top-down effects at the scale of a local
community. While these clade-specific studies often find weak evidence for
phylogenetic signal in ecologically-relevant traits, studies at the level of the
whole biosphere [@Gomez2010;@Bersier2008] demonstrate that related organisms
often have similar interspecific interactions -- i.e. related predators often
consume similar prey. At the level of a community, the effect of a predator
assemblage will depend on both the spatial distribution and trophic interactions of all
predator species. Phylogeny may constrain species distributions when distant
relatives have distinct fundamental niches, while close relatives are too
similar to co-exist [@Webb2002;@Emerson2008] -- for predators, this means that
similar taxa may not be able to occupy the same compartment of a food web
[@Rezende2009]. By correlating with these properties, measures of phylogenetic
diversity may allow us to predict the effect of a predator assemblage on
ecosystem functioning.

Within predator assemblages, there may be considerable variation in the
abundance and distribution of related taxa. If habitat patches are variable, and
if the fundamental niche of different organisms varies with relatedness, then we
would expect a phylogenetic signal to patterns of occurrence.  Specifically, if
related predators share habitat requirements, then we expect to find them in the
same patches -- unless their similarity precludes their co-occurrence.  This
relationship between relatedness and distribution is he most common way in which
phylogenetic information is used in community ecology [@Cavender-Bares2009]. In
metacommunities -- i.e. when patches are connected by dispersal -- variation in
the composition of a local assemblage is also determined by species dispersal
into, and selection among, habitat patches
[@Leibold2004;@Howeth2010a;@Calcagno2011a]. The effects of other predators can
be important too: during dispersal, assembly can be nonrandom if predators use
cues of the presence of prey, competitors, or intra-guild predators when colonizing
[@Chase2009a;@McCauley2008a;@Srivastava2008]. After colonization, patterns of
co-occurrence may be further modified by intraguild predation
[@Lounibos2008;@Juliano2009] or competition [@Fincke1997].

When predators co-occur, their feeding mode, diet breadth and nutritional
requirements will determine which prey they consume and the 
potential total amount of predation. Because such morphological traits may
well be conserved over evolutionary time, the breadth of differentiation (and
hence resource use) may also show a phylogenetic signal; this differentiation in
resource use leads to complementarity and greater overall ecosystem function
[@Finke2008a]. Among predators, feeding mode is an important trait that is
conserved within lineages and determines a large part of diet breadth.  For
example, some predators are gape-limited, and can swallow any prey smaller than
their mouth; these predators typically broaden their diet as they grow (e.g.,
larvae of Odonata) [@Werner1984].  Such ontogenetic changes in diet breadth can
radically influence food web structure [@Moya-Larano2011]. Other
predators (e.g. Leeches, or Diptera:Tabanidae) are "piercing-sucking" predators
[@Bay1974] and may be more general consumers at all life stages, since they can
feed on larger prey individuals even at very early predator life stages.  In
some cases, predator diets may extend to include other predators leading to
direct negative interactions such as intraguild predation, which may also have a
phylogenetic signal [@Pfennig2000].

Predator interactions are common in many communities, and can lead to
nonlinearities which prevent the inference of predator effect from the additive
combination of individual predators [@Sih1998a]. For example, decreasing
predator richness has been shown to increase herbivory in a three-level kelp
food web [@Byrnes2006]. The complex traits that underlie such species
interactions (particularly "higher-order" interactions *sensu* Sih *et al.*
[-@Sih1998a]) may also correlate with phylogeny, leading to a higher correlation
with community processes than richness alone [@Cadotte2009]. For example,
phylogenetically diverse assemblages of mycorrhizae increased primary
productivity more than equally speciose treatments from the same lineage
[@Maherali2007]. The effect of predators on prey may also be non-additive, the
result of indirect interactions either with prey species or other predators:
prey species may respond to the presence of one predator by a behavioural shift
that increases the predation by another predator population [@Carey2010a]. These
trait-mediated indirect effects (TMII, [@Werner2003]) can be difficult to predict;
however phylogenetic relatedness has been suggested as a possible means of
predicting the combined effect of predators [@Naisbit2011]

We used a series of observations, lab feeding trials, and manipulative field
experiments to measure how the phylogenetic diversity of the predator assemblage
predicts community composition and ecosystem function.  We test three related
hypotheses concerning co-occurance patterns, diet similarity and top-down
ecosystem effects of diverse predators, using a natural mesocosm: the community
of invertebrates living within bromeliads. Bromeliads (Bromeliaceae) are
epiphytic plants native to the Neotropics. Many bromeliad species contain water, detritus
and a complex insect food web within their leaves; the decomposition of this
detritus supplies nutrients for the bromeliad [@Benzing2000]. The small size of
these habitats permits direct manipulations of entire food webs, manipulations
which would be difficult in most natural systems.  Within this aquatic food web, damselfly larvae (e.g. *Leptagrion* spp., Odonata:Coenagrionidae) are important predators;
their presence dramatically alters community dynamics (e.g. decreases
insect emergence [@Starzomski2010] and increases nutrient cycling
[@Ngai2006]). 

1. *species co-occurrence*: closely-related predators may occur together more frequently than less-related predators if there is a strong phylogenetic signal to habitat requirements.   Alternatively, very closely related species may never co-occur because high overlap in ecological niches results in competitive exclusion.

2. *diet similarity*: similarity in diet (as measured by feeding trials)
decreases with phylogenetic distance if diet is phylogenetically conserved. Alternatively,  closely related species may have evolved different diets to allow coexistence.

3. *ecosystem-level effects*: Our experiments at the level of the whole habitat patch (i.e. a single bromeliad) allows us to examine direct and indirect effects of predator combinations.
    a) monoculture treatments allow us to assess the effect of each predator on a complete prey community and ecosystem function.  Phylogenetic similarity among predators is predicted to  correlate with similarity in single-species effects if related predators share similar trophic interactions (e.g. predation rate, diet breadth)
    b) By comparing treatments with pairs of predators to treatments which received a monoculture of each predator, we are able to estimate additive and nonadditive effects.  If distance between species correlates with increasing difference, we will see an increase in these non-additive effects with phylogenetic distance. At the extreme, differences between predators may lead to IGP among predators.

## Methods

## Site and Species

We conducted all observations and experiments in Parque Estadual da Ilha do
Cardoso ($25^{\circ} 03^{\prime}$ S, $47^{\circ}53^{\prime}$ W), a 22.5 ha
island off the south coast of São Paulo state, Brazil. We worked in a closed
coastal forest (restinga) the understory of which is mostly covered by
_*Quesnelia arvensis*_ Mez. (Bromeliaceae), a large terrestrial bromeliad that
accumulates up to 2.8 L of rainwater in tanks formed by individual leaves. Previous observational surveys of this work found more than 47 species of macroinvertebrates in these aquatic communities [@Romero2010].
This diversity encompasses multiple trophic groups.  Detritivores include various functional groups: shredders
(Diptera:Tipulidae, Trichoptera), scrapers (Coleoptera:Scirtidae), and collectors
(All Diptera:Chironomidae, Syrphidae, Psychodidae). Filter feeders (Diptera:Culicidae) are supported by the microbial components of the food web. A
diverse predator assemblage consists of at least 3 species of damselfly larvae (_Leptagrion_ spp., Zygoptera:Coenagrionidae), 2 species of predatory Horse Fly larvae (Diptera:Tabanidae), and 2
species of leech (Hirudinidae).  Other, smaller-bodied predators present include predatory midge larvae (Diptera:Chironomidae:Tanypodinae) and less abundant species such as Dytiscid beetles.

### Phylogenetic distance, metabolic capacity and niche overlap

```{r CALC_nodeages}

nodeages <- list.files(path="../data/TreeData",pattern="*.csv",full.names=TRUE) %>%
  data.frame(paths = .,stringsAsFactors = FALSE) %>%
  mutate(nodename = basename(paths) %>% gsub(".csv","",.)) %>%
  group_by(nodename) %>%
  do(age_data = read.csv(.$paths)) %>%
  mutate(Nstudies = nrow(age_data),
         minT = min(age_data %>% extract2("Time")),
         maxT = max(age_data %>% extract2("Time")))


## move to supp mat
phylogeny_node_age <- nodeages %>%
  select(nodename,age_data,Nstudies) %>% 
  do(extract2(.,"age_data") %>% as.data.frame(stringsAsFactors = FALSE)) %>%
  lapply(.,function(x) gsub(pattern = "\\(.+\\)",replacement = "",x)) %>% 
  data.frame

# function to print out range

agerange <- function(Name,pna = nodeages){
  minT <- pna %>%
    filter(nodename == Name) %>%
    extract2("minT")
  
  maxT <- pna %>%
    filter(nodename == Name) %>%
    extract2("maxT")
  
  paste0(minT," to ",maxT)
  }

nstudy <- function(Name, dat = nodeages){
  dat %>%
    filter(nodename == Name) %>%
    extract2("Nstudies")
  }

              
n.nodes <- nrow(nodeages)
nstudies <- sum(nodeages$nstudies)

# nodeages <- lapply(list.files(path="../data/TreeData/",pattern="*.csv",full.names=TRUE),read.csv)
# names(nodeages) <- list.files(path="../data/TreeData/",pattern="*.csv")
# nstudies <- sapply(nodeages,nrow)
# #names(nodeages)[which(nstudies>1)]
# n.nodes <- length(nodeages)
```
In 2008, we counted and measured macroinvertebrates in an observational study of `r ncol(metabolic)-1` bromeliads. Within this observational dataset, we
identified `r metabolic$Taxa %>% unique %>% length` species as predators.
These predators include species related at the genus level -- e.g. _Bezzia_ sp.
(Diptera:Ceratopogonidae) with two species and _Leptagrion_ sp.
(Odonata:Coenagrionidae) with three -- and family level (three species of
Tabanidae and two of Empididae, all Diptera).  Deeper divisions are also present: three families of Diptera are represented by a single predator species each (Dolichopodidae, Corethrellidae and
Chironomidae) and the deepest taxonomic divide is between all insects present and a
species of predatory leech (Annelida:Hirudinidae).

We obtained node age estimates for all seven internal nodes of the tree, using `www.timetree.org`, an online database of published  molecular time estimates from the literature [@Hedges2006].  Most dates came from only a single study; where multiple dates were found we used the median estimate: Insecta--Hirudina (`r agerange("insects.to.leeches")` Mya, n=`r nstudy("insects.to.leeches")` studies), Odonata--Tabanidae (`r agerange("odonata-Tabanidae")` Mya, n=`r nstudy("odonata-Tabanidae.csv")` studies) and Tabanidae--Diptera (`r agerange("tabanidae_culidicae_ie_Diptera")` Mya, n=`r nstudy("tabanidae_culidicae_ie_Diptera")` studies).  Node age data was available
for all but the shallowest nodes of the tree, where either a lack of taxonomic
information (e.g. Tabanidae) or a lack of phylogenetic study (e.g. _Leptagrion_)
prevented more information from being included.   These branches were left as
polytomies, and were all assigned identical, arbitrary and short branch lengths
(15 Mya).

Species co-occurrence is often measured in terms of non-random patterns of
species occurrence or abundance, but such measures will only be poorly related
to the functional effects of species when species differ substantially in body
size.  Integrating the allometric relationship between body size and feeding
rate [@Brown2004; @Wilby2005] over all individuals of a species allows estimates
of "metabolic capacity", or the potential energy requirements of a species
[@Srivastava2009a]. Metabolic capacity is equal to individual body
mass raised to the power of 0.69 (an insect-specific exponent determined by Peters 19xx, [@Chown2007]); this reflects the nonlinearity of feeding rate
on body size across many invertebrate taxa. We used metabolic capacity to inform
both our observational results and our experimental design (details below), with the exception
of our feeding trial data.  This is because the feeding trials were intended to
measure which prey our predators ate, rather than their feeding rate (only the
latter should scale with metabolic capacity).

Questions 1 and 2 above focus on niche overlap between predator species. Question 1 hypothesizes that if diet is conserved, then diet similarity declines with increased phylogenetic distance between a pair of predators. Question 2 hypothesizes that if habitat preference is phylogenetically conserved and competition between predators unimportant, then co-occurence declines with increased phylogenetic distance between a pair of predators. We evaluated both diet similarity and co-occurence between predators using Pianka's index of niche overlap [@Pianka1974]:

$O_{kl}=\dfrac{\sum_i^n{p_{il} p_{ik}}}{\sqrt{\sum_i^n{p_{il}^2} \sum_i^n{p_{ik}^2}}}$

For each pair of predators, $p_{ik}$ and $p_{il}$ represent the preference of
predator $k$ (or $l$) for resource or habitat $i$. In terms of predator co-occurrence, $n$=`r ncol(metabolic)-1` bromeliads surveyed in the observational dataset described below. In terms of diet similarity, the number of resources ($n$) is defined as the total number of prey
species assayed with both predator taxa, and preference is defined as the
proportion of diet trials (see below) for each predator-prey assay that resulted in prey
mortality.  

We quantified the effect of phylogenetic distance on each of distributional and diet similarity.  First, we calculated phylogenetic distance between each pair of species, then fit several functions to this relationship (linear, constant, and several appropriate nonlinear functions).  We compared these models using AIC, selected the best model, and generated confidence intervals as appropriate (parametric or bootstrap for linear and nonlinear, respectively).

###  Distributional Similarity 

We used the 2008 survey to examine patterns of co-occurrence among predator taxa.  Each bromeliad was dissected and washed to remove invertebrates.  The
resulting water was filtered through two sieves (250 and 850 µm), which removed
particulate organic matter without losing any invertebrates.  All invertebrates
were counted and identified to the lowest taxonomic level possible. The body
length of all individuals was measured, when possible for small and medium-sized taxa (< 1cm final instar) and always for large-bodied taxa (> 1 cm final instar).

We calculated total metabolic capacity of each predator species in each
bromeliad by summing estimates of biomass for all individuals of the same
species within a plant.  We used these values to calculate niche overlap as
measured by habitat occupancy.  Overlap was calculated for each pair of
predators across all bromeliads, even if neither species occurred there.

### Diet Similarity
```{r CALC_feeding_trials}
##  predator x prey trials


## numbers for text
ntrials <- sum(feeding_trials$number.trials)
npred <- length(unique(feeding_trials$predator.names))
nprey <- length(unique(feeding_trials$Prey.species))
ncombos <- nrow(feeding_trials)
rep_range <- range(feeding_trials$number.trials)
```

We conducted `r ntrials` feeding trials of `r npred` predator taxa fed `r nprey` prey taxa between March and April 2011.  We  covered all potential predator-prey pairs present in the experiment
(described below), and attempted to perform all other trials whenever possible. However, due to the rarity of some taxa many predator-prey pairs were not possible; we tested `r ncombos` pairwise combinations.  Most trials were replicated at least five times, but the number of replicates for various combinations ranged from `r rep_range[[1]]` to `r rep_range[[2]]`. We placed
predators together with prey in a 50ml vial, with a leaf or stick for
substrate. The only exception was the tabanid larvae, which we
placed between two vertical surfaces to imitate the narrow space found in
bromeliad leaf axils, their preferred microhabitat.  Generally our trials contained a single predator and a
single prey individual, except in the case of very small prey (_Elpidium_ sp.)
or predators (_Monopelopia_ sp.) in which case we increased the density.  We
replicated each combination up to five times where possible, and allowed one day for
predation to occur.

Again, we estimated overlap between different predators using Pianka's index,
using the proportion of trials which resulted in predation as our measure of
predator preference. Because not every predator/prey pair was equally
replicated, we weighted our analysis by  the number of trials conducted.

### Community effect experiment

Our experiment was created with two goals in mind: first, to measure the major
effects of each of these predators on their prey and ecosystem function and second, to estimate the non-
additive effects of pairwise predator combinations.  The strength of these non-additive effects could then be related to the phylogenetic distance between a pair of predator species.

We selected the four most common predators in this system, which also created a
range of relatedness: two congeneric damselflies (*Leptagrion andromache* and
*Leptagrion elongatum*), two insects (*L. elongatum* and a Tabanid predatory
fly), and two invertebrates (*L. elongatum* and leeches).  We used each of the
pairs of predators just described, as well as each species in monoculture, and a
predator-free control (8 treatments, n=5).  Combinations were substitutive,
maintaining the same amount of total predator metabolic capacity to isolate the
effects of predator behaviour and traits. Substitutive experiments often hold
total abundance constant, but when species differ substantially in body size -
as in this experiment - allometric effects of body size on feeding rate can
confound detection of effects based on trophic traits or species
interactions, and standardizing to community metabolic capacity is preferred
[@Srivastava2009a]. This experiment allows the
estimation of the effect of each predator species (monoculture treatments), as
well as the detection of non- additive effects in predator combinations.

In Feburary 2011, bromeliads between 90 and 200ml in capacity were collected, thoroughly
washed to remove organisms and detritus and soaked for 12 hours in a tub of water.  They were then hung for 48
hours to dry.  One bromeliad dissected after this procedure contained no
insects.

Each bromeliad was supplied with dried leaves, simulating natural detritus
inputs from the canopy.  We enriched these leaves with ^15^N by fertilizing five
(Jabuticaba, *Plinia cauliflora*) plants with 40ml pot^-1^ day^-1^ of 5g L^-1^
ammonium sulphate containing 10% atom excess of ^15^N over 21 days. Whole leaves
were then picked from plants and air-dried until constant weight, and then
soaked for three days and the water discarded. About 1.5 g of leaves were placed
in each bromeliad (`r mean(pd$mass.g.)`g ± `r sd(pd$mass.g.)`).

Each bromeliad was stocked with a representative insect community. The densities
of each prey taxon were calculated from the 2008 observational dataset, using
data from bromeliads of similar size to those in our experiment.  All densities
used were within the range of these calculated abundances, and all experimental
bromeliads received the same insect community.  Halfway through the experiment,
insects were added to bromeliads a second time to simulate the continuous
oviposition that characterizes the system.  Throughout the experiment, all bromeliads were enclosed
with a mesh cage topped with a malaise trap and checked daily for emergence of
adults.

In this experiment we measured five response variables: production of fine
particulate organic matter (FPOM), decomposition of coarse detritus, bromeliad
growth, uptakle of detrital nitrogen into bromeliad tissue, and survival of invertebrate prey (emerged adults +
surviving larvae). We analyzed each of these responses with ANOVA.  For each pair of predator species and each response type, we
calculated the non-additive effect as the difference between the
response in bromeliads with both predator species (n=5) and the mean response in bromeliads with either one of these two predator species 
(n=5 for each predator species).  We generated bootstrap confidence intervals for
these nonadditive effects; confidence intervals which do not overlap zero
indicate a significant non-additive effect of a predator combination.



## Results

### Patterns of occurrence

```{r CALC_phylogenetic_distance}
####### metabolic matrix ####
## we need to calculate two distance matrices:
## 1) metabolic capacity distance
## 2) phylogenetic distance

## metabolic matrix -- the "distance" between predator co-occurance, measured as metabolism

####### phylogeny matrix ####
## Calculate distances
phylogenetic_distance  <- predtree_timetree_ages %>%
  cophenetic() %>%
  matrix_to_df() %>%
  select(phylopred1=Var1,
         phylopred2=Var2,
         phylodistance=value) %>%
  mutate(pairs_RH=paste0(phylopred1,"_",phylopred2),
         pairs_LH=paste0(phylopred2,"_",phylopred1)
         ) %>%
  melt(id.vars=c("phylopred1","phylopred2","phylodistance"),
       value.name="species_pair",
       variable.name="L_or_R") 
## my 

```

```{r CALC_metabolic_distance}

metabolic_distance <- paired_predator_pianka(pred_x_resource = metabolic,pred_colname = "Taxa",... =-Taxa)

```

```{r CALC_diet_overlap}
## When calculating similiarity, we start with a predator (row) by resource (column) dataframe.
# pred x prey matrix, with cells = proportion eate

# feeding_trials %>% arrange(predator.names) %>% mutate(prop.eaten=eaten/number.trials)

prop.eaten <- feeding_trials %>% 
  filter(!Prey.species %in% c("Leptagrion andromache <5mm",
                              "Leptagrion.elongatum")) %>% 
  filter(!predator.names %in% c("Phylloicus bromeliarum", "Dysticid")) %>%
  mutate(prop.eaten=eaten/number.trials) %>%
  arrange(predator.names,Prey.species) %>%
  select(-number.trials,-eaten) %>%
  spread(Prey.species,prop.eaten,fill = NA)
   #dcast(predator.names~Prey.species,value.var="prop.eaten",fun.aggregate = mean)

diet_overlap <- paired_predator_pianka(pred_x_resource = prop.eaten,
                                       pred_colname = "predator.names",
                                       -predator.names)

```

```{r CALC_summarize_random_test}
## summarize randomization test results
betternames <- c("elong + andro" = "Leptagrion.elongatum_Leptagrion.andromache",
                 "elong + tab" = "Leptagrion.elongatum_Tabanidae.spA",
                 "elong + leech" = "Leptagrion.elongatum_Hirudinidae")
                 
summarize_random_test <- rand.means %>%
  # remove annoying X column
  select(-X) %>%
  # melt, so that all responses can be summarized at the same time
  gather(response_var,value,-sp.pair) %>%
  group_by(sp.pair,response_var) %>%
  summarise(mean=mean(value),
            lower=quantile(value,probs=c(0.025)),
            upper=quantile(value,probs=c(0.975))
            ) %>%
  # sequence of increasing PD
  ungroup() %>%
  mutate(species_pair = betternames[sp.pair] %>% as.character)
```

```{r DATA_merge}
## we need to merge together several matrices:
## metabolic occurance + predator phylogenetic distance
## diet similarity + predator phylogenetic distance
## experiment randomization results + predator phylogenetic distance

## note that the nomeclature of the columns keeps `sp.pair` as the only shared name among columns.
metabolic_occur_phylo <- metabolic_distance %>%
  left_join(phylogenetic_distance)

diet_overlap_phylo <- left_join(diet_overlap,phylogenetic_distance)

summarize_randoms_phylo <- left_join(summarize_random_test,phylogenetic_distance)

```

```{r CALC_metabolic_numbers}
## numbers for text:
meta_range <- metabolic %>%
  melt(id.vars="Taxa") %>%
  select(-variable) %>%
  filter(value>0) %>%
  filter(value%in%range(value)) %>%
  transform(value=signif(value,2)) %>%
  unique()

smallsp <- meta_range[1,]
largesp <- meta_range[2,]

nspp <- metabolic %>%
  melt(id.vars="Taxa",variable.name="brom") %>%
  filter(value>0) %>% 
  group_by(brom) %>%
  summarise(nspp=n()) %>%
  summarise(meanpred=mean(nspp),
            sdpred=signif(sd(nspp),2)) 

```

```{r TEST_metabolic~phylo}
meta_phylo_lm_summary <- with(metabolic_occur_phylo,lm(overlap~phylodistance)) %>%
  summary()

## caculate summaries 
pval_metabol <- round(pf(meta_phylo_lm_summary$fstatistic[1],
                         meta_phylo_lm_summary$fstatistic[2],
                         meta_phylo_lm_summary$fstatistic[3],lower.tail=FALSE)
                      ,digits=2)
```

Across all bromeliads, predator species differed widely in metabolic capacity, from `r smallsp$value` for a species of _Monopelopia_ to `r largesp$value` for large predatory flies in the family Tabanidae.  Predators often co-occurred in bromeliads (`r nspp$meanpred` ± `r nspp$sdpred` predator species per plant).  However, the niche overlap between the total metabolic capacity of pairs of predators did not show any relationship with phylogenetic distance between them (F~`r meta_phylo_lm_summary$fstatistic[["numdf"]]`,`r meta_phylo_lm_summary$fstatistic[["dendf"]]`~=`r meta_phylo_lm_summary$fstatistic[["value"]]`, p=`r pval_metabol`).

### diet similarity

```{r CALC_diet_numbers}
## Diet numbers for text:
## what percentage of total trials resulted in predation?
percentpredation <- feeding_trials %>%
  transform(percent.eaten=eaten/number.trials) %>%
  group_by(predator.names) %>%
  summarise(mean.pred=mean(percent.eaten),
            totaltrials=sum(number.trials),
            nprey=n())
  
andro <- percentpredation %>%
  filter(predator.names=="Leptagrion.andromache") %>%
  select(mean.pred) %>%
  transform(mean.pred=round(mean.pred*100,1)) %>%
  as.numeric()

elong <- percentpredation %>%
  filter(predator.names=="Leptagrion.elongatum") %>%
  select(mean.pred) %>%
  transform(mean.pred=round(mean.pred*100,1)) %>%
  as.numeric()
  
```

```{r TEST_diet-sim_as_PD,results='asis'}
## test a squared term with 
# 
# diet_overlap_phylo %>%
#   #filter(nspp>1) %>%
#   with(lm(overlap~phylodistance,weights=nspp)) %>%
#   pander(caption="Linear model of diet overlap as a function of phylogenetic distance between predators.")

#summary(dietoverlap_lm)

diet_phylo_lm_summary <- diet_overlap_phylo %>%
  #filter(nspp>1) %>%
  with(lm(overlap~phylodistance,weights=nspp)) %>%
  summary()



# diet_phylo_lm_summary <- diet_overlap_phylo %>%
#   #filter(nspp>1) %>%
#   glm(overlap~phylodistance,weights=nspp,data=.,family=binomial) %>%
#   summary()


dietmat <- diet_overlap_phylo %>%
  select(-species_pair) %>%
  unique() %>%
  dcast(phylopred1~phylopred2,value.var="overlap") %>%
  data.frame(row.names="phylopred1") %>%
  as.matrix()

```

Among the most common predator taxa (i.e. those used in our experiment, described below) the damselflies (_Leptagrion andromache_ and _Leptagrion elongatum_) showed the highest rates of prey consumption (prey consumed in `r andro`% and `r elong`% of trials, respectively). All predators showed a very generalist diet breadth, consuming nearly all species offered to them.  However, more phylogenetically distant predators differed in their preference of prey species, as measured by the niche overlap index (F~`r diet_phylo_lm_summary$fstatistic[["numdf"]]`,
`r diet_phylo_lm_summary$fstatistic[["dendf"]]`~=`r round(diet_phylo_lm_summary $fstatistic[["value"]],2)`, p=`r round(pf(diet_phylo_lm_summary $fstatistic[1],diet_phylo_lm_summary $fstatistic[2],diet_phylo_lm_summary $fstatistic[3],lower.tail=FALSE),digits=3)`, regression weighted by the number of prey species assayed.)

### Ecosystem-level effects and phylogenetic distance

```{r experimentsummary}
predeffect <- function(resp="total.surv"){
  diffeffect <- (mean(pd[[resp]][pd$treatment!="control"],na.rm=TRUE)-mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE))/mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE)
  round(diffeffect,digits=2)*100
  }
# 
# ddply(pd,.(treatment),summarize,meansurv=mean(total.surv))
# 
# mean(pd$emerged)
# mean(rowSums(pd[c("Culicidae","Chironomidae","Tipulidae","Scirtidae")])
```

In our manipulative experiment, we placed a standardized prey community into bromeliads and measured five response variables. Predators had a large effect on prey survivorship: on average all predator treatments showed `r abs(predeffect())`% lower prey emerging or surviving as larvae relative to the predator-free control.  Nitrogen transport to bromeliad leaves was slightly decreased in bromeliads with predators relative to predator-free controls (`r predeffect("N")`%), and was only higher than the control in treatments including Tabanid predators.  We found a similar pattern for plant growth: on average, predators had a `r predeffect("growth")`% effect on growth of bromeliad leaves (leaf elongation in mm), though Tabanids seemed to create a slight increase. The decomposition of coarse detritus and production of fine organic matter showed no obvious pattern related to the presence of predators.

```{r polysummary}
polyeffect <- function(resp="total.surv"){
  diffeffect <- (mean(pd[[resp]][pd$treatment%in%c("elong + andro","elong + leech","elong + tab")],na.rm=TRUE)-mean(pd[[resp]][pd$treatment%in%c("andro","tabanid","leech","elong")],na.rm=TRUE))/mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE)
  round(diffeffect,digits=2)*100
  }

```

Predator combinations tended to have a non-additive effect on our response variables, even though we held total metabolic capacity constant amongst all treatments.  Approximately `r polyeffect()`% more prey survived in polyculture, on average,  compared to all monocultures.  Nitrogen uptake increased by (`r polyeffect("N")`%) and bromeliad growth by (`r polyeffect("growth")`%). Production of fine particulate organic matter increased by `r polyeffect("fine")`% more when predators were present in combination.

Our experimental design allows us to estimate the non-additive effect of predator species pairs on whole communities of prey, and the functioning of the bromeliad ecosystem.  We used randomization tests to test the hypothesis that increased phylogenetic distance between members of a predator pair results in a greater magnitude of nonadditive effect.  We contrasted the differences of the mean individual predator treatments from the control with the mean difference of their pairwise combination from the control.  

We found the greatest effect for prey survival: while effects of _L. andromache_ and _L. elongatum_ in combination were quite similar to the effect of either alone, when _L. elongatum_ was placed in the same plant as either a Tabanid larva or leeches, on average five more prey individuals (18% of total prey community) survived till the end of the experiment (Fig 3).  This effect was smaller among the other variables, most of which showed confidence intervals from the randomization test which overlap zero.


### Figures

```{r FIG_metabolic_occurance_as_phylo,fig.cap="Figure 1: Phylogenetic distance and predator co-occurrence.  Each point represents a pair of predator species.  We calculated total metabolic capacity for each predator species in each bromeliad, and then calculated niche overlap between two predators using Pianka's index. Solid line shows the best fit non-linear model (see Appendix) and dashed lines show bootstrap 95% quantiles. ",dev='png'}

if(FALSE) {
  model_aic <- metabolic_occur_phylo %>% 
    ungroup %>% 
    select(phylodistance,overlap) %>%
    fit_some_models
  write.csv(model_aic,file = "distributional_similarity.csv")
  }

metabolic_occur_phylo %>% 
  ungroup %>% 
  select(phylodistance,overlap) %>%
  pianka_plot

```


```{r FIG_feeding_trial_as_phylo, fig.cap="Figure 2:  Diet overlap decreases with phylogenetic distance, based on 237 feeding trials with the 8 major predator taxa found in this system.  Diet similarity is calculated as Pianka's index of niche overlap. Solid line shows the best fit non-linear model (see Appendix) and dashed lines show bootstrap 95% quantiles.",dev='png'}

f_extract <- function(f,.models) sapply(.models,function(x) f(x[[1]]))

if(TRUE){
models <- diet_overlap_phylo %>% 
  ungroup %>% 
  select(phylodistance,overlap,nspp) %>%
  do(quadratic = nls(overlap ~ a * (phylodistance)^2 + b * phylodistance + c, 
                     data = ., 
                     start = list(a = -0.0000008, b = 0.0008, c = 1),
                     weights = nspp),
     bellshaped = nls(overlap ~ peak * exp(-1 * (phylodistance)^2 / a), 
                      data = ., 
                      start = list(a = 900000, peak = 1),
                      weights = nspp),    
     exponential = nls(overlap ~ b * exp(a * phylodistance),
                       data = .,
                       start = list(a = -0.0004, b = 1),
                       weights = nspp),
     #        Sshaped = nls(overlap ~ c * exp(a * phylodistance) / 
     #                        (c * exp(a * phylodistance) + (1 - c)),
     #                      data = .,
     #                      start = list(a = -0.007, c = 0.9)),
     linear = nls(overlap ~ a* phylodistance + b, 
                  data = .,
                  start = list(a = -0.1,b = 0.7), weights = nspp),
     constant = nls(overlap ~ z,
                    data = .,
                    start = list(z = 0.4),
                    weights = nspp)
     ) 
  
data.frame(model = names(models),
           AIC = f_extract(AIC,models)) %>%
  arrange(AIC) %>%
  write.csv(file = "diet_similarity.csv")
}

exponential <- function(x,a,b) b * exp(a * x)

fig2 <- diet_overlap_phylo %>% 
  ungroup %>%
  select(phylodistance,overlap,nspp) %>%
  ggplot(aes(x = phylodistance, y = overlap)) + 
  geom_point(aes(size = nspp), shape  = 21) + 
  geom_point(aes(size = nspp), colour = "black", fill = "#00A08A", shape  = 21, alpha = 0.6) + 
  xlab("Phylogenetic distance") + ylab("Diet similarity (Pianka's index)") + 
  scale_size(range = c(3,9),name="Number of\nprey") +
  mytheme

# fig2 + stat_function(fun = exponential,args = f_extract(coef)$exponential %>% as.list , size = 1)

x_sequence <- diet_overlap_phylo  %>%
  ungroup %>%
  summarise(min_x = min(phylodistance),
            max_x = max(phylodistance)) %>%
  do(seq(from = .$min_x,
         to = .$max_x,
         length.out = 500) %>%
       data.frame(phylodistance = .)
     ) 

rawdata <- diet_overlap_phylo %>% 
  ungroup %>% 
  select(phylodistance,overlap,nspp)

predictions  <-  replicate(
  100,{
    boot  <- rawdata[sample.int(nrow(rawdata), replace = TRUE), ]
    #browser()
    model = nls(overlap ~ b * exp(a * phylodistance), 
                data = boot, 
                start = list(a = -0.0004, b = 1),
                weights = nspp)
    # Output predictions at each point that we'll want to plot later
    if(!is.null(model)) {
      predict(model, 
              data.frame(x = x_sequence))
      }
    else {
      rep(NA,length(x_sequence))
      }
    },
  simplify = FALSE
  )

predictions  <- do.call(cbind,predictions)

observed_fit <- nls(overlap ~ b * exp(a * phylodistance), 
                    data = rawdata, 
                    start = list(a = -0.0004, b = 1),
                    weights = nspp)

x_sequence %>% tbl_df %>%
  mutate(pred_m2 = predict(observed_fit,newdata = list(phylodistance = phylodistance)),
         upper = apply(predictions,1,quantile,prob = .975, na.rm = TRUE),
         lower = apply(predictions,1,quantile,prob = .025, na.rm = TRUE)
         ) %>% 
  #  gather(model,prediction,-phylodistance) %>%
  (function(x) fig2 + geom_line(aes(x = phylodistance, y = pred_m2),data = x) +
     geom_line(aes(x = phylodistance, y = upper),data = x,linetype = "dashed") +
     geom_line(aes(x = phylodistance, y = lower),data = x,linetype = "dashed")
   ) 



```



```{r FIG_PD_experiment_nonadditive,fig.cap="Figure 3: Combinations of predators beyond congenerics show a negative non-additive effect on predation rate.  Points represent the mean difference between the means of two monocultures compared to the mean of a polycultures.  These values are presented as differences from (predator free) controls; therefore zero indicates no significant non-additive effect. Relative to control (no predator) plants, bromeliads containing two predators which were not congeneric showed less predation",dev='png'}

summarize_randoms_phylo %>% 
  filter(response_var == "survival") %>%
  
ggplot(aes(x=phylodistance,y=mean)) + 
  geom_linerange(aes(ymin=lower, ymax=upper)) + 
  geom_point(size=6,shape = 21, colour = "black", fill = "#00A08A") + 
  ylab("Mean treatment difference, Control-Treatment") + 
  xlab("Time (Mya)") + 
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey") + 
  mytheme

# 
# ggplot(summarize_randoms_phylo,
#        aes(x=Time,y=mean))+geom_errorbar(aes(ymin=lower, ymax=upper),width=0)+geom_point(size=3)+ylab("Mean treatment difference, Control-Treatment")+xlab("Time (Mya)")+facet_wrap(~variable)
```

```{r TABLE_communityexperiment,fig.height=3.5,dev='png'}
exp_summary <- pd %>%
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  melt(id.vars="treatment") %>%
  group_by(treatment,variable) %>%
  summarise(meanval=mean(value),
            n=n(),
            sd=sd(value)) %>%
  mutate(SE=sd/sqrt(n),
         meanval_sig=signif(meanval,2),
         SE_sig=signif(SE,2),
         meanSE=paste(meanval_sig,"±",SE_sig)) %>%
  dcast(treatment~variable,value.var="meanSE")

test <- exp_summary[c(2,1,3,7,8,4,5,6),] %>%
  data.frame(row.names="treatment") %>%
  select(surviving=total.surv,
         fineDetritus=fine,
         decomposition=decomp,
         bromeliadGrowth=growth,
         N)


coltext <- expression("surviving insects","fine detritus (g)","leaf decomposition (g)",
                      "bromeliad growth (g)","Nitrogen cycling")


grid.table(test,cols=coltext,gpar.colfill=gpar(fill="white",col="white"),
           row.just="left",gp=gpar(cex=0.6),gpar.rowtext=gpar(),show.vlines=TRUE
           )
```

```{r testtable, results = 'asis'}
# 
# pd %>%
#   select(treatment,total.surv,fine,decomp,growth,N) %>%
#   stargazer(type = "html")
```

## Discussion





## References