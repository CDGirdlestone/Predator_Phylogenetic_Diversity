---
title: "Predator phylogenetic diversity decreases predation rate via antagonistic interactions"
author: "Andrew MacDonald; Diane S. Srivastava; Gustavo Q. Romero"
output:
  word_document:
    reference_docx: reference.docx
  md_document: default
  html_document: default
bibliography: /home/andrew/Documents/Mendeley_reference_lists/@MS_pdpaper.bib
---

```{r options_packages_data, message=FALSE, echo=FALSE}
## set chunk options
library(knitr)
opts_chunk$set(message=FALSE,warning=FALSE,echo=FALSE,fig.cap=FALSE,dev="png")

## load packages
library(ggplot2)
library(bipartite)
library(reshape2)
library(vegan)
library(picante)
library(pander)
library(gplots)
library(plyr)
library(gridExtra)
library(dplyr)
library(magrittr)
library(knitr)
library(xtable)
library(stargazer)

# occurrance data -- abundance
occur <- read.csv("../data/reorganized_data/predator.cooccur.txt",stringsAsFactor=FALSE) %.%
  tbl_df()
# occurrance data -- metabolic capacity
metabolic  <- read.csv("../data/reorganized_data/predator.cooccur.metabolic.txt",
                       stringsAsFactor=FALSE) %.%
  tbl_df()
# feeding trial data
foodweb <- read.csv("../data/reorganized_data/reorganized.feeding.trial.data.csv",
                    stringsAsFactors=FALSE) %.%
  tbl_df()
# experimental data
pd <- read.csv("../data/reorganized_data/pd_exp_cleaned_data.csv",stringsAsFactors=FALSE) %.%
  tbl_df()
# enriched leaves -- ie just the N data for the detritus we put in.
enriched <- read.csv("../data/reorganized_data/enriched_leaves.csv",stringsAsFactors=FALSE) %.%
  tbl_df()
# phylogeny data
predtree_timetree_ages <- read.tree("../data/reorganized_data/predator_tree_time.newick")
# randomization tests
rand.means <- read.csv("../data/predator.div.experiment/randomizations.group.means.csv") %.%
  tbl_df()

## load in functions
source("../R.scripts/FUNCTIONS_predator_diversity.R")

#source("../R.scripts/cleanup_organization_for_graphing_analysis.R")
```

```{r experiment_data_postprocess}
#dropping a record that seems to have been 90% decomposed!
pd <- pd %.%
  transform(decomp=ifelse(decomp>0.7,NA,decomp))
```

## Introduction

Predator assemblages can have strong top-down effects, both on community
structure and ecosystem processes [@Estes2011].  Detailed studies manipulating
predators have identified a great diversity of direct and indirect mechanisms
for these effects, related to interspecific variation in habitat selection and
interactions with both prey and other predators.  Within a community predators
will have widely different preferences for different microhabitats, or
behavioural responses to fine-scale environmental variation.  When predators do
co-occur in a local patch, they may feed on different prey species as determined
by microhabitat preference, foraging behaviour, and other traits [@Schmitz2007].
Predator-predator interactions will further modify the effect of a diverse
consumer assemblage, as predators may feed directly on each other (Intra-guild
predation) or may modify the behaviour of predators or prey via non-consumptive
(ie trait-mediated) interactions [@Sih1998a;@Griswold2006;@Nystrom2001].  While
there are many mechanisms, we lack a means of estimating the importance of each
in a community.  Srivastava et al. [-@Srivastava2012c] hypothesized that the
phylogenetic diversity of a community or assemblage may correlate with increased
ecosystem function, via increases in trait diversity; however this has yet to be
tested. Here we quantify phylogenetic diversity (PD) of a diverse invertebrate
predator assemblage and ask if PD is associated with variation in habitat
preferences, diet composition and intraguild interactions.

Phylogenetic diversity measures have provided useful insights into diverse plant
communities [@Cadotte2009;@Cadotte2008;@Godoy2014], and yet have rarely been
applied to local assemblages of predators [@Bersier2008;@Naisbit2011]. Many
studies of phylogenetic signal in consumer traits focus on whole clades, rather
than local assemblages (e.g. *Anolis* lizards [@Knouft2006], warbler [@Bohning-Gaese2003], treeboas [@Henderson2013] and wasps [@Udriene2005]) making it
difficult to connect these results to top-down effects at the scale of a local
community. While these clade-specific studies often find weak evidence for
phylogenetic signal in ecologically-relevant traits, studies at the level of the
whole biosphere [@Gomez2010;@Bersier2008] demonstrate that related organisms
often have similar interspecific interactions -- i.e. related predators often
consume similar prey. At the level of a community, the effect of a predator
assemblage will depend on both the distribution and trophic interactions of all
predator species. Phylogeny may constrain species distributions when distant
relatives have distinct fundamental niches, while close relatives are too
similar to co-occur [@Webb2002;@Emerson2008] -- for predators, this means that
similar taxa may not be able to occupy the same compartment of a food web
[@Rezende2009]. By correlating with these properties, measures of phylogenetic
diversity may allow us to predict the effect of a predator assemblage on
ecosystem functioning.

Within predator assemblages, there may be considerable variation in the
abundance and distribution of related taxa. If habitat patches are variable, and
if the fundamental niche of different organisms varies with relatedness, then we
would expect a phylogenetic signal to patterns of occurrence.  Specifically, if
related predators share habitat requirements, then we expect to find them in the
same patches -- unless their similarity precludes their co-occurrence.  This
relationship between relatedness and distribution is he most common way in which
phylogenetic information is used in community ecology [@Cavender-Bares2009]. In
metacommunities -- i.e. when patches are connected by dispersal -- variation in
the composition of a local assemblage is also determined by species dispersal
into, and selection among, habitat patches
[@Leibold2004;@Howeth2010a;@Calcagno2011a]. The effects of other predators can
be important too: during dispersal, assembly can be nonrandom if predators use
cues of presence of prey, competitors, or intra-guild predators when colonizing
[@Chase2009a;@McCauley2008a;@Srivastava2008]. After colonization, patterns of
co-occurrence may be further modified by intraguild predation
[@Lounibos2008;@Juliano2009] or competition [@Fincke1997].

When predators co-occur, their feeding mode, diet breadth and nutritional
requirements of predators will determine which prey they consume and the total
potential amount of predation that occurs. Because such morphological traits may
well be conserved over evolutionary time, the breadth of differentiation (and
hence resource use) may also show a phylogenetic signal; this differentiation in
resource use leads to complementarity and greater overall ecosystem function
[@Finke2008a]. Among predators, feeding mode is an important trait that is
conserved within lineages and determines a large part of diet breadth.  For
example, some predators are gape-limited, and can swallow any prey smaller than
their mouth; these predators typically broaden their diet as they grow (e.g.,
larvae of Odonata) [@Werner1984].  Such ontogenetic changes in diet breadth can
radically influence all of food web structure [@Moya-Larano2011]. Other
predators (e.g. Leeches, or Diptera:Tabanidae) are "piercing-sucking" predators
[@Bay1974] and may be more general consumers at all life stages, since they an
feed on larger prey individuals even at very early predator life stages.  In
some cases, predator diets may extend to include other predators leading to
direct negative interactions such as intraguild predation, which may also have a
phylogenetic signal [@Pfennig2000].

Predator interactions are common in many communities, and can lead to
nonlinearities which prevent the inference of predator effect from the additive
combination of individual predators [@Sih1998a]. For example, decreasing
predator richness has been shown to increase herbivory in a three-level kelp
food web [@Byrnes2006]. The complex traits that underlie such species
interactions (particularly "higher-order" interactions *sensu* Sih *et al.*
[-@Sih1998a]) may also correlate with phylogeny, leading to a higher correlation
with community processes than richness alone [@Cadotte2009]. For example,
phylogenetically diverse assemblages of mycorrhizae increased primary
productivity more than equally speciose treatments from the same lineage
[@Maherali2007]. The effect of predators on prey may also be non-additive, the
result of indirect interactions either with prey species or other predators:
prey species may respond to the presence of one predator by a behavioural shift
that increases the predation by another predator population [@Carey2010a]. These
trait-mediated indirect effects (TMII, [@Werner2003]) can be difficult to predict;
however phylogenetic relatedness has been suggested as a possible means of
predicting the combined effect of predators [@Naisbit2011]

We used a series of observations, lab feeding trials, and manipulative field
experiments to measure how the phylogenetic diversity of the predator assemblage
predicts community composition and ecosystem function.  We test three related
hypotheses concerning co-occurance patterns, diet similarity and top-down
ecosystem effects of diverse predators, using a natural mesocosm: the community
of invertebrates living within bromeliads. Bromeliads (Bromeliaceae) are
epiphytic plants native to the Neotropics; many species contain water, detritus
and a complex insect food web within their leaves; the decomposition of this
detritus supplies nutrients for the bromeliad [@Benzing2000]. The small size of
these habitats permits direct manipulations of entire food webs, manipulations
which would be difficult in most natural systems.  Within this aquatic food web, damselfly larvae (e.g. *Leptagrion* spp., Odonata:Coenagrionidae) are important predators;
their presence dramatically alters community dynamics (e.g. decreasing rates of
insect emergence [@Starzomski2010] and increasing nutrient cycling
[@Ngai2006]). 

1. *species co-occurance*: closely-related predators may occur together more frequently than less-related predators if there is a strong phylogenetic signal to habitat requirements.   Alternatively, very closely related species may never co-occur because high overlap in ecological niches results in competitive exclusion.

2. *diet similarity*: similarity in diet (as measured by feeding trials)
decreases with phylogenetic distance if diet is phylogentically conserved. Alternatively,  closely related species may have evolved different diets to allow coexistence.

3. *ecosystem-level effects*: Our experiments at the level of the whole habitat patch (i.e. a single bromeliad) allows us to examine direct and indirect effects of predator combinations.
    a) monoculture treatments allow us to assess the effect of each predator on a complete prey community and ecosystem function.  Phylogenetic similarity among predators is predicted to  correlate with similarity in single-species effects if related predators share similar trophic interactions (e.g. predation rate, diet breadth or magnitude of TMII)
    b) By comparing treatments with pairs of predators to treatments which received a monoculture of each predator, we are able to estimate additive and non-additive effects.  If distance between species correlates with increasing difference, we will see an increase in these non-additive effects with phylogenetic distance. At the extreme, differences between predators may lead to IGP among predators.

## Methods

## Site and Species

We conducted all observations and experiments in Parque Estadual da Ilha do
Cardoso ($25^{\circ} 03^{\prime}$ S, $47^{\circ}53^{\prime}$ W), a 22.5 ha
island off the south coast of São Paulo state, Brazil. We worked in a closed
coastal forest (restinga) the understory of which is mostly covered by
_Quesnelia arvensis_ Mez. (Bromeliaceae), a large terrestrial bromeliad that
accumulates up to 2.8 L of rainwater in tanks formed by individual leaves. More
than 47 species of macroinvertebrates are found in these aquatic communities.
This diversity encompasses an entire foodweb, from detrital shredders
(Diptera:Tipulidae, Trichoptera), detrital scrapers (Coleoptera:Scirtidae), collectors
(All Diptera:Chironomidae, Syrphidae, Psychodidae), and filter feeders (Diptera:Culicidae) to a
diverse predator assemblage consisting of at least 3 species of damselfly larvae (_Leptagrion_ spp., Zygoptera:Coenagrionidae), 2 species of predatory Horse Fly larvae (Diptera:Tabanidae), and 2
species of leech (Hirudinidae).  Many other smaller or occasional predators also
occur, such as predatory midge larvae (Diptera:Chironomidae:Tanypodinae) and Dytiscid beetles.

### Phylogenetic distance, metabolic capacity and niche overlap

```{r CALC_nodeages}
nodeages <- lapply(list.files(path="../data/TreeData/",pattern="*.csv",full.names=TRUE),read.csv)
names(nodeages) <- list.files(path="../data/TreeData/",pattern="*.csv")
nstudies <- sapply(nodeages,nrow)
#names(nodeages)[which(nstudies>1)]
n.nodes <- length(nodeages)
```
In 2008, we counted and measured macroinvertebrates in an observational study of `r ncol(metabolic)-1` bromeliads. Within this observational dataset, we
identified `r metabolic$Taxa %>% unique %>% length` species as predators.
These predators include species related at the genus level -- e.g. _Bezzia_ sp.
(Diptera:Ceratopogonidae) with two species and _Leptagrion_ sp.
(Odonata:Coenagrionidae) with three -- and family level (three species of
Tabanidae and two of Empididae, all Diptera).  Deeper divisions are also present: three families of Diptera are represented by a single predator species each (Dolichopodidae, Corethrellidae and
Chironomidae) and the deepest taxonomic divide is between all insects present and a
species of predatory leech (Annelida:Hirudinidae).

We obtained node age estimates for all `r n.nodes` internal nodes of the tree, using www.timetree.org, an online database of published  molecular time estimates from the literature [@Hedges2006].  Most dates came from only a single study; where multiple dates were found we used the median estimate: Insecta--Hirudina (`r paste(range(nodeages[["insects.to.leeches.csv"]]$Time),collapse=" to ")` Mya, n=`r nstudies[["insects.to.leeches.csv"]]` studies), Odonata--Tabanidae (`r paste(range(nodeages[["odonata-Tabanidae.csv"]]$Time),collapse=" to ")` Mya, n=`r nstudies[["odonata-Tabanidae.csv"]]` studies) and Tabanidae--Diptera (`r paste(range(nodeages[["odonata-Tabanidae.csv"]]$Time),collapse=" to ")` Mya, n=`r nstudies[["tabanidae_culidicae_ie_Diptera.csv"]]` studies).  Node age data was available
for all but the shallowest nodes of the tree, where either a lack of taxonomic
information (e.g. Tabanidae) or a lack of phylogenetic study (e.g. _Leptagrion_)
prevented more information from being included.   These branches were left as
polytomies, and were all assigned identical, arbitrary and short branch lengths
(15 Mya).

Species co-occurrence is often measured in terms of non-random patterns of
species occurrence or abundance, but such measures will only be poorly related
to the functional effects of species when species differ substantially in body
size.  Integrating the allometric relationship between body size and feeding
rate [@Brown2004; @Wilby2005] over all individuals of a species allows estimates
of "metabolic capacity", or the potential energy requirements of a species
[@Srivastava2009a;Chown2007]. Metabolic capacity is equal to individual body
mass raised to the power of 0.69; this reflects the nonlinearity of feeding rate
on body size across many invertebrate taxa. We used metabolic capacity to inform
both our observational results and our experimental design (details below), with the exception
of our feeding trial data.  This is because the feeding trials were intended to
measure which prey our predators ate, rather than their feeding rate (only the
latter should scale with metabolic capacity).

We evaluated overlap in predator diet preference using Pianka's index of niche overlap [@Pianka1974]:

$O_{kl}=\dfrac{\sum_i^n{p_{il} p_{ik}}}{\sqrt{\sum_i^n{p_{il}^2} \sum_i^n{p_{ik}^2}}}$

For each pair of predators, $p_{ik}$ and $p_{il}$ represent the preference of
predator $k$ (r $l$) for prey species $i$.  The number of prey species ($n$) is
defined as the total number of prey species assayed with both predator taxa, and
preference is defined as the proportion of trials for each predator-prey assay
that resulted in prey mortality.


###  Observations of predator distribution 

We used the 2008 survey to examine patterns of co-occurrence among predator taxa.  Each bromeliad was dissected and washed to remove invertebrates.  The
resulting water was filtered through two sieves (250 and 850 µm), which removed
particulate organic matter without losing any invertebrates.  All invertebrates
were counted and identified to the lowest taxonomic level possible. The body
length of all individuals was measured, when possible.

We calculated total metabolic capacity of each predator species in each
bromeliad by summing estimates of biomass for all individuals of the same
species within a plant.  We used these values to calculate niche overlap as
measured by habitat occupancy.  Overlap was calculated for each pair of
predators across all bromeliads, even if neither species occurred there.

### Diet similarity
```{r CALC_feeding_trials}
##  predator x prey trials

feeding_trials <- foodweb %.%
  group_by(Prey.species,predator.names) %.%
  summarize(number.trials=n(),
            eaten=sum(eaten.numeric)
            ) %.%
  filter(!is.na(predator.names)) %.%
  filter(predator.names!="Leptagrion.small") %.%
  ungroup()

## numbers for text
ntrials <- sum(feeding_trials$number.trials)
npred <- length(unique(feeding_trials$predator.names))
nprey <- length(unique(feeding_trials$Prey.species))
ncombos <- nrow(feeding_trials)
rep_range <- range(feeding_trials$number.trials)
```

We conducted `r ntrials` feeding trials of `r npred` predator taxa fed `r nprey` prey taxa between March and April 2011.  We  covered all potential predator-prey pairs present in the experiment
(described below), and attempted to perform all other trials whenever possible. However, due to the rarity of some taxa many predator-prey pairs were not possible; we tested `r ncombos` pairwise combinations.  Most trials were replicated at least five times, but the number of replicates for various combinations ranged from `r rep_range[[1]]` to `r rep_range[[2]]`. We placed
predators together with prey in a 50ml vial, with a leaf or stick for
substrate. The only exception was the tabanid larvae, which we
placed between two vertical surfaces to imitate the narrow space found in
bromeliad leaf axils, their preferred microhabitat.  Generally our trials contained a single predator and a
single prey individual, except in the case of very small prey (_Elpidium_ sp.)
or predators (_Monopelopia_ sp.) in which case we increased the density.  We
replicated each combination up to five times where possible, and allowed one day for
predation to occur.

Again, we estimated overlap between different predators using Pianka's index,
using the proportion of trials which resulted in predation as our measure of
predator preference. Because not not every predator/prey pair was equally
replicated we weighted our analysis by  the number of trials conducted.


### Community effect experiment

<!-- Abundance-based phylogenetic diversity measure : convert to metabolic capacity based?? 
  [@Cadotte2010] -->

Our experiment was created with two goals in mind: first, to measure the major
effects of each of these predators on their prey and second, to estimate the non-
additive effects of pairwise predator combinations.  The strength of these non
additive effects can then be related back to the phylogenetic distance between
each member of a pair of predators.

We selected the four most common predators in this system, which also created a
range of relatedness: two congeneric damselflies (*Leptagrion andromache* and
*Leptagrion elongatum*), two insects (*L. elongatum* and a Tabanid predatory
fly), and two invertebrates (*L. elongatum* and leeches).  We used each of the
pairs of predators just described, as well as each species in monoculture, and a
predator-free control (8 treatments, n=5).  Combinations were substitutive,
maintaining the same amount of total predator metabolic capacity to isolate the
effects of predator behaviour and traits. Substitutive experiments often hold
total abundance constant, but when species differ substantially in body size -
as in this experiment - allometric effects of body size on feeding rate can
confound detection of non-additive effects based on trophic traits or species
interactions, and standardizing to community metabolic capacity is preferred
[@Srivastava2009a]. Response variables included the rate of decomposition of
leaves, bromeliad growth and insect emergence.  This experiment allows the
estimation of the effect of each predator species (monoculture treatments), as
well as the detection of non- additive effects in predator combinations.

In Feburary 2011, bromeliads between 90 and 200ml were collected, thoroughly
washed and soaked for 12 hours in a tub of water.  They were then hung for 48
hours to dry.  One bromeliad dissected after this procedure contained no
insects.

Each bromeliad was supplied with dried leaves, simulating natural detritus
inputs from the canopy.  We enriched these leaves with N-15 by fertilizing five
(Jabuticaba, *Plinia cauliflora*) plants with 40ml pot^-1^ day^-1^ of 5g/L ammonium
sulphate containing 10% atom excess of N15. *duration*. started on
27 January 2011 Whole leaves were then picked from plants and air-dried until constant
weight, and then soaked for three days and the water discarded. About 1.5 g of
leaves were placed in each bromeliad (`r mean(pd$mass.g.)`g ± `r sd(pd$mass.g.)`).

Each bromeliad was stocked with a representative insect community. The densities
of each prey taxon were calculated from the 2008 observational dataset, using
data from bromeliads of similar size to those in our experiment.  All densities
used were within the range of these calculated abundances, and all experimental
bromeliads received the same insect community.  Halfway through the experiment,
insects were added to bromeliads a second time to simulate the continuous
oviposition that characterizes the system.  After addition of the prey community, all bromeliads were enclosed
with a mesh cage topped with a malaise trap and checked daily for emergence of
adults.

In this experiment we measured five response variables: production of fine
particulate organic matter (FPOM), decomposition of coarse detritus, bromeliad
growth, cycling of nitrogen into plant tissue, and survival of prey (emerged adults +
surviving larvae). We analyzed each of these responses with ANOVA.  We
calculated the non-additive response as follows: the difference between the
polyculture mean (n=5) and the mean of both monoculture means for each predator
(n=5 for each monoculture).  We generated bootstrap confidence intervals for
these nonadditive effects; confidence intervals which do not overlap zero
indicate a significant nonadditive effect of a predator combination.



## Results

### patterns of occurance

```{r CALC_phylogenetic_distance}
####### metabolic matrix ####
## we need to calculate two distance matrices:
## 1) metabolic capacity distance
## 2) phylogenetic distance

## metabolic matrix -- the "distance" between predator co-occurance, measured as metabolism

dist_to_df <- function(matrix_for_df){
  melt(matrix_for_df)[melt(upper.tri(matrix_for_df))$value,]
}


####### phylogeny matrix ####
## Calculate distances
phylogenetic_distance  <- predtree_timetree_ages %.%
  cophenetic() %.%
  dist_to_df() %.%
  rename(c("Var1"="phylopred1",
           "Var2"="phylopred2",
           "value"="phylodistance")) %.%
  mutate(pairs_RH=paste(phylopred1,phylopred2,sep="_"),
         pairs_LH=paste(phylopred2,phylopred1,sep="_")) %.%
  melt(id.vars=c("phylopred1","phylopred2","phylodistance"),
       value.name="species_pair",
       variable.name="L_or_R") 

```

```{r CALC_metabolic_distance}
metabolic_distance <- metabolic %.%
  data.frame(row.names="Taxa") %.%
  as.matrix() %.%
  vegdist(method="euclid") %.%
  as.matrix() %.%
  dist_to_df() %.%
  rename(c("Var1"="metapred1",
           "Var2"="metapred2",
           "value"="metadistance")) %.%
  mutate(species_pair=paste0(metapred1,"_",metapred2))

```

```{r CALC_diet_overlap}
# Check for TRUE ZEROS in cast matrix.

## Fill = 0 !!!? correct ??!!!

## similarity in diet is about how much they eat

## Should this be the proportion of eating?!?

# pred x prey matrix, with cells = proportion eaten
prop.eaten <- feeding_trials %.%
  mutate(prop.eaten=eaten/number.trials) %.%
  dcast(predator.names~Prey.species,value.var="prop.eaten")
  
## a table, with one four rows for each pair of predators.  This is necessary for connecting.  it causes repeats. 
predators <- expand.grid(pred1=unique(feeding_trials$predator.names),
                         pred2=unique(feeding_trials$predator.names)) %.%
  filter(pred1!=pred2) %.%
  transform(pred_pair=paste0(pred1,"_",pred2)) %.%
  melt(id.vars="pred_pair",value.name="predator.names",variable.name="p") %.%
  left_join(prop.eaten) %.%
  select(-p,-predator.names)

## both ecopath and ecosim documentation (and those sources derived from them)
## imply a different formula for Pianka's index.
pianka <- function(df){
  mat <- as.matrix(df[,-1])
  # scale rows
  rowtotal <- rowSums(mat)
  mat <- apply(mat,2,function(x) x/rowtotal)

  squares <- mat^2
  sum_sq_prod <- prod(rowSums(squares))
  
  prod <- apply(mat,2,prod)
  sum_prod <- sum(prod)
  
  overlap <- sum_prod/sqrt(sum_sq_prod)
  nspp <- ncol(mat)
  data.frame(overlap,nspp)
}

outer_paste <-   function(x) outer(x,x,paste,sep="_")

prednames <- feeding_trials$predator.names %.%
  unique() %.%
  outer_paste()

predpairs <- prednames %.%
  melt(value.name="species_pair") %.%
  transform(species_pair=as.character(species_pair)) %.%
  semi_join(
    {
      prednames %.%
        upper.tri() %.%
        melt(value.name="corner") %.%
        filter(corner)
      },
    by=c("Var1","Var2")
    ) %.%
  transform(pred1=unique(feeding_trials$predator.names)[Var1],
            pred2=unique(feeding_trials$predator.names)[Var2]) %.%
  select(pred1,pred2,species_pair) %.%
  arrange(pred1,pred2)

diet_overlap <- split(predators,predators$pred_pair) %.%
  lapply(function(x) x[colSums(!is.na(x))>1]) %.%
  lapply(pianka) %.%
  ldply(stringsAsFactors=FALSE) %.%
  rename(c(".id"="species_pair")) %.%
  semi_join(predpairs)

metabolic

```

```{r metabolictest}

## a table, with one four rows for each pair of predators.  This is necessary for connecting.  it causes repeats. 
predators <- expand.grid(pred1=unique(metabolic$Taxa),
                         pred2=unique(metabolic$Taxa)) %.%
  filter(pred1!=pred2) %.%
  transform(pred_pair=paste0(pred1,"_",pred2)) %.%
  melt(id.vars="pred_pair",value.name="Taxa",variable.name="p") %.%
  left_join(metabolic) %.%
  select(-p)

## both ecopath and ecosim documentation (and those sources derived from them)
## imply a different formula for Pianka's index.
pianka <- function(df){
  mat <- as.matrix(df[,-1])
  # scale rows
  rowtotal <- rowSums(mat)
  mat <- apply(mat,2,function(x) x/rowtotal)

  squares <- mat^2
  sum_sq_prod <- prod(rowSums(squares))
  
  prod <- apply(mat,2,prod)
  sum_prod <- sum(prod)
  
  overlap <- sum_prod/sqrt(sum_sq_prod)
  nspp <- ncol(mat)
  data.frame(overlap,nspp)
}

outer_paste <-   function(x) outer(x,x,paste,sep="_")

prednames <- metabolic$Taxa %.%
  unique() %.%
  outer_paste()

predpairs <- prednames %.%
  melt(value.name="species_pair") %.%
  transform(species_pair=as.character(species_pair)) %.%
  semi_join(
    {
      prednames %.%
        upper.tri() %.%
        melt(value.name="corner") %.%
        filter(corner)
      },
    by=c("Var1","Var2")
    ) %.%
  transform(pred1=unique(metabolic$Taxa)[Var1],
            pred2=unique(metabolic$Taxa)[Var2]) %.%
  select(pred1,pred2,species_pair) %.%
  arrange(pred1,pred2)

pres_overlap <- predators %>%
  select(-Taxa) %>%
  split(predators$pred_pair) %.%
  #lapply(function(x) x[colSums(!is.na(x))>1]) %.%
  lapply(pianka) %.%
  ldply(stringsAsFactors=FALSE) %.%
  rename(c(".id"="species_pair")) %.%
  semi_join(predpairs)

```

```{r CALC_summarize_random_test}
## summarize randomization test results

summarize_random_test <- rand.means %.%
  # remove annoying X column
  select(-X) %.%
  # melt, so that all responses can be summarized at the same time
  melt(id.vars="sp.pair") %.%
  group_by(sp.pair,variable) %.%
  summarise(mean=mean(value),
            lower=quantile(value,probs=c(0.025)),
            upper=quantile(value,probs=c(0.975))
            ) %.%
  # sequence of increasing PD
  ungroup() %.%
  mutate(sp.pair.names=factor(sp.pair,levels=c('elong + andro',
                                         'elong + tab',
                                         'elong + leech')
                        ),
         sp.pair=as.character(sp.pair),
         sp.pair=ifelse(sp.pair=="elong + andro","Leptagrion.elongatum_Leptagrion.andromache",
                        sp.pair),
         sp.pair=ifelse(sp.pair=="elong + tab","Leptagrion.elongatum_Tabanidae.spA",
                        sp.pair),
         sp.pair=ifelse(sp.pair=="elong + leech","Leptagrion.elongatum_Hirudinidae",
                        sp.pair)
         
         ) %.%
  rename(c("sp.pair"="species_pair"))


```

```{r DATA_merge}
## we need to merge together several matrices:
## metabolic occurance + predator phylogenetic distance
## diet similarity + predator phylogenetic distance
## experiment randomization results + predator phylogenetic distance

## note that the nomeclature of the columns keeps `sp.pair` as the only shared name among columns.
metabolic_occur_phylo <- left_join(metabolic_distance,phylogenetic_distance)

metatest <- left_join(pres_overlap,phylogenetic_distance)

diet_overlap_phylo <- left_join(diet_overlap,phylogenetic_distance)

summarize_randoms_phylo <- left_join(summarize_random_test,phylogenetic_distance)

```

```{r CALC_metabolic_numbers}
## numbers for text:
meta_range <- metabolic %.%
  melt(id.vars="Taxa") %.%
  select(-variable) %.%
  filter(value>0) %.%
  filter(value%in%range(value)) %.%
  transform(value=signif(value,2)) %.%
  unique()

smallsp <- meta_range[1,]
largesp <- meta_range[2,]

nspp <- metabolic %.%
  melt(id.vars="Taxa",variable.name="brom") %.%
  filter(value>0) %.%
  group_by(brom) %.%
  summarize(nspp=n()) %.%
  summarize(meanpred=mean(nspp),
            sdpred=signif(sd(nspp),2)) 

```

```{r TEST_metabolic~phylo}
meta_phylo_lm_summary <- with(metabolic_occur_phylo,lm(metadistance~phylodistance)) %.%
  summary()

## caculate summaries 
pval_metabol <- round(pf(meta_phylo_lm_summary$fstatistic[1],
                         meta_phylo_lm_summary$fstatistic[2],
                         meta_phylo_lm_summary$fstatistic[3],lower.tail=FALSE)
                      ,digits=2)
```

Across all bromeliads, predator species differed widely in metabolic capacity, from `r smallsp$value` for a species of _Monopelopia_ to `r largesp$value` for large predatory flies in the family Tabanidae.  Predators often co-occured in bromeliads (`r nspp$meanpred` ± `r nspp$sdpred` predator species per plant).  However, the euclidian distance between the total metabolic capacity of pairs of predators did not show any relationship with phylogenetic distance between them (F~`r meta_phylo_lm_summary$fstatistic[["numdf"]]`,`r meta_phylo_lm_summary$fstatistic[["dendf"]]`~=`r meta_phylo_lm_summary$fstatistic[["value"]]`, p=`r pval_metabol`).

### diet similarity

```{r CALC_diet_numbers}
## Diet numbers for text:
## what percentage of total trials resulted in predation?
percentpredation <- feeding_trials %.%
  transform(percent.eaten=eaten/number.trials) %.%
  group_by(predator.names) %.%
  summarize(mean.pred=mean(percent.eaten),
            totaltrials=sum(number.trials),
            nprey=n())
  
andro <- percentpredation %.%
  filter(predator.names=="Leptagrion.andromache") %.%
  select(mean.pred) %.%
  transform(mean.pred=round(mean.pred*100,1)) %.%
  as.numeric()

elong <- percentpredation %.%
  filter(predator.names=="Leptagrion.elongatum") %.%
  select(mean.pred) %.%
  transform(mean.pred=round(mean.pred*100,1)) %.%
  as.numeric()
  
```

```{r TEST_diet-sim_as_PD,results='asis'}
## test a squared term with 
# 
# diet_overlap_phylo %.%
#   #filter(nspp>1) %.%
#   with(lm(overlap~phylodistance,weights=nspp)) %.%
#   pander(caption="Linear model of diet overlap as a function of phylogenetic distance between predators.")

#summary(dietoverlap_lm)

diet_phylo_lm_summary <- diet_overlap_phylo %.%
  #filter(nspp>1) %.%
  with(lm(overlap~phylodistance,weights=nspp)) %.%
  summary()


dietmat <- diet_overlap_phylo %.%
  select(-species_pair) %.%
  unique() %.%
  dcast(phylopred1~phylopred2,value.var="overlap") %.%
  data.frame(row.names="phylopred1") %.%
  as.matrix()

```

Among the most common predator taxa (i.e. those used in our experiment, described below) the damselflies (_Leptagrion andromache_ and _Leptagrion elongatum_) showed the highest rates of prey consumption (prey consumed in `r andro`% and `r elong`% of trials, respectively). All predators showed a very generalist diet breadth, consuming nearly all species offered to them.  However, more phylogenetically distant predators differed in their preference of prey species, as measured by the niche overlap index (F~`r diet_phylo_lm_summary$fstatistic[["numdf"]]`,
`r diet_phylo_lm_summary$fstatistic[["dendf"]]`~=`r round(diet_phylo_lm_summary $fstatistic[["value"]],2)`, p=`r round(pf(diet_phylo_lm_summary $fstatistic[1],diet_phylo_lm_summary $fstatistic[2],diet_phylo_lm_summary $fstatistic[3],lower.tail=FALSE),digits=3)`, regression weighted by the number of prey species assayed.)

### Ecosystem-level effects and phylogenetic distance

```{r experimentsummary}
predeffect <- function(resp="total.surv"){
  diffeffect <- (mean(pd[[resp]][pd$treatment!="control"],na.rm=TRUE)-mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE))/mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE)
  round(diffeffect,digits=2)*100
  }
# 
# ddply(pd,.(treatment),summarize,meansurv=mean(total.surv))
# 
# mean(pd$emerged)
# mean(rowSums(pd[c("Culicidae","Chironomidae","Tipulidae","Scirtidae")])
```

In our manipulative experiment, we placed a standardized prey community into bromeliads and measured five response variables. Predators had a large effect on prey survivorship: on average all predator treatments showed `r abs(predeffect())`% lower prey emerging or surviving as larvae relative to the predator-free control.  Nitrogen transport to bromeliad leaves was slightly decreased relative to controls (`r predeffect("N")`%), and was only higher than the control in treatments including Tabanid predators.  We found a similar pattern for plant growth: on average, predators had a `r predeffect("growth")`% effect on growth of bromeliad leaves (mm), though Tabanids seemed to create a slight increase. The decomposition of coarse detritus and production of fine organic matter showed no obvious pattern related to the mere presence of predators.


<!--
Add stats to above paragraph: the two "orthogonal" questions of how predators affect communities independently and how they affect them non-additively (in combination)  
-->


```{r polysummary}
polyeffect <- function(resp="total.surv"){
  diffeffect <- (mean(pd[[resp]][pd$treatment%in%c("elong + andro","elong + leech","elong + tab")],na.rm=TRUE)-mean(pd[[resp]][pd$treatment%in%c("andro","tabanid","leech","elong")],na.rm=TRUE))/mean(pd[[resp]][pd$treatment=="control"],na.rm=TRUE)
  round(diffeffect,digits=2)*100
  }

```

<!--
stats in following paragraph!  
-->

Predator combinations tended to have a non-additive effect on our response variables, even though we held total metabolic capacity constant amongst all treatments.  Approximately `r polyeffect()`% more prey survived in polyculture, on average,  compared to all monocultures.  Nitrogen uptake increased by (`r polyeffect("N")`%) and bromeliad growth by (`r polyeffect("growth")`%). Production of fine particulate organic matter increased by `r polyeffect("fine")`% more when predators were present in combination.

Our experimental design allows us to estimate the non-additive effect of predator species pairs on whole communities of prey, and the functioning of the bromeliad ecosystem.  We used randomization tests to test the hypothesis that increased phylogenetic distance between members of a predator pair results in a greater magnitude of nonadditive effect.  We contrasted the differences of the mean individual predator treatments from the control with the mean difference of their pairwise combination from the control.  
<!-- previous sentence rather complex-sounding. how about an equation? -->
<!-- need stats for these response variables, too -->

We found the greatest effect for prey survival: while effects of _L. andromache_ and _L. elongatum_ in combination were quite similar to the effect of either alone, when _L. elongatum_ was placed in the same plant as either a Tabanid larva or leeches, on average five more prey individuals (18% of total prey community) survived till the end of the experiment (Fig 3).  This effect was smaller among the other variables, most of which showed confidence intervals from the randomization test which overlap 0.


### Figures

```{r FIG_metabolic_occurance_as_phylo,fig.cap="Figure 1: Phylogenetic distance and predator co-occurrence.  Each point represents a pair of predator species.  We calculated total metabolic capacity for each predator species in each bromeliad, and then calculated co-occurrence between two predators as the euclidean distance between total metabolic capacity of two species.",dev='svg'}
ggplot(metabolic_occur_phylo,
       aes(x=phylodistance,y=metadistance))+geom_point()+xlab("phylogenetic distance")+ylab("euclidian distance between total metabolic capacity")

ggplot(metatest,aes(x=phylodistance,y=overlap))+geom_point(size=3,alpha=0.3) + stat_smooth(method = "loess",span=0.8)

```


```{r FIG_feeding_trial_as_phylo, fig.cap="Figure 2: Phylogenetic distance and diet similarity.  We performed 237 feeding trials with the 8 major predator taxa found in this system.  We found that more distantly-related predators consume more dissimiliar prey.  We measured diet similarity as euclidian distance among feeding trial outcomes; this measure includes information about the number of predation events in each predator-prey pairing.  Regression was weighted by the sample size of the predator-prey pair.",dev='png'}

diet_overlap_phylo %.%
  #filter(nspp>1) %.%
  ggplot(aes(x=phylodistance,y=overlap,size=nspp)) %.%
  +geom_point() %.%
  +stat_smooth(method="lm",size=1) %.%
  +scale_size_continuous(range=c(2,6),name="Number of \n prey spp.") %.%
  +xlab("phylogenetic distance") + ylab("niche overlap")

```



```{r FIG_PD_experiment_nonadditive,fig.cap="Figure 4: Combinations of predators beyond congenerics show a negative non-additive effect on predation rate.  Points represent the mean difference between the means of two monocultures compared to the mean of a polycultures.  These values are presented as differences from (predator free) controls; therefore 0 indicates no significant non-additive effect. Relative to control (no predator) plants, bromeliads containing two predators which were not congeneric showed less predation",dev='svg'}
ggplot(subset(summarize_randoms_phylo,summarize_randoms_phylo$variable=="survival"),
       aes(x=phylodistance,y=mean))+geom_errorbar(aes(ymin=lower, ymax=upper),width=0)+geom_point(size=3)+ylab("Mean treatment difference, Control-Treatment")+xlab("Time (Mya)")
# 
# ggplot(summarize_randoms_phylo,
#        aes(x=Time,y=mean))+geom_errorbar(aes(ymin=lower, ymax=upper),width=0)+geom_point(size=3)+ylab("Mean treatment difference, Control-Treatment")+xlab("Time (Mya)")+facet_wrap(~variable)
```

```{r TABLE_communityexperiment,fig.height=3.5,dev='svg'}
exp_summary <- pd %.%
  select(treatment,total.surv,fine,decomp,growth,N) %.%
  melt(id.vars="treatment") %.%
  group_by(treatment,variable) %.%
  summarise(meanval=mean(value),
            n=n(),
            sd=sd(value)) %.%
  mutate(SE=sd/sqrt(n),
         meanval_sig=signif(meanval,2),
         SE_sig=signif(SE,2),
         meanSE=paste(meanval_sig,"±",SE_sig)) %.%
  dcast(treatment~variable,value.var="meanSE")

test <- exp_summary[c(2,1,3,7,8,4,5,6),] %.%
  data.frame(row.names="treatment") %.%
  rename(c("total.surv"="surviving",
           "fine"="fine detritus",
           "decomp"="decomposition",
           "growth"="bromeliad growth"))


coltext <- expression("surviving insects","fine detritus (g)","leaf decomposition (g)",
                      "bromeliad growth (g)","Nitrogen cycling")


grid.table(test,cols=coltext,gpar.colfill=gpar(fill="white",col="white"),
           row.just="left",gp=gpar(cex=0.6),gpar.rowtext=gpar(),show.vlines=TRUE
           )
```

## Discussion

### co-occurrence
Predators appear to be generalist with regard to their habitat preference; indicating that prey face a heterogeneous landscape of predator risks, and demonstrating that our experimental design captures natural variation in predator composition

Predators occurring together at smaller spatial scales (i.e. within the same plant) may have limited direct interactions due to habitat structure, for example via the physical obstructions caused by detritus ().  Srivastava found that such habitat complexity within a bromeliad -- specifically the presence of coarse detritus -- reduces the amount of predation by damselflies.  It is not clear how these factors might influence the other predators in this system.  Effects might be similar for leeches, which are also active predators.  Tabanids are sit-and-wait predators, living deep in leaf axils, so it is likely that they are less affected by local patch structural conditions than other predators.  

two important steps -- oviposition decisions and survival -- determine organism coexistence in bromeliad patches.

Predator lifecycles can be quite long in this system, much longer than the lives of invertebrate prey (Robin).  As a result, actively dispersing inverts are probably faced with choices among various predation-risks in patches.  While this is beyond the sope of our work, we report evidence for both strong IGp nonliearities in predation amount, and a broad overlap in predator co-occurance. This indicates that, at the level of the metacommunity, discrete patches have varying amounts of predator biomass, which may not necessarily correlate with the amount of predation pressure they may face.

Habitat selection is difficult to ascertain from observational data.  Especially given that animals in this system have difference lifecycles.  The insects are rapidly changing (smaller insects) while large predators may say or a while,and physical detritus longer still. 

hm.  there's an idea: if there is IGP or TMII among predators, that means composition or biomass of predators can be decoupled from predation rate.  That could lead to strange decisions by insects, with nonintuitive results.

### diet similarity
* We demonstrate a slight but important decrease in feeding preferences with phylogenetic distance, indicating that food web structure itself might vary with phylogenetic diversity, becoming more compartmentalized when predators are more dissimilar.
 
calulate predatr's feeding rate nd diet breath simultaneously, and relate this to their phylogenetic distance from each other.
could be that there is a phylgenetic signal in the prey eaten?  not really our focus here.  in fact we are more interested in whether similar predators have similar effects on communities.  

* The differences in predation rates and diet breadth among our predators represents important trait differences between the groups involved, including differences in metabolic rate (physiological literature) and feeding mode. (for example, Tabanids and leeches are peircing predators, while Leptagrion is gape-limited.)

Diet similarity, like occurance, also has two components: predator 

### community experiment

* Phylogenetically diverse predator assemblages showed more prey survivorship (i.e. less predation) than expected; this may be to strong trait-mediated indirect effects on the feeding rate of _Leptagrion elongatum_ when in the presence of other non-damselfly predators.

Trait-mediated indirect effects may be common in nature [@Werner2003]. In our system we observed less predation in predator combinations, perhaps because the damselflies lowered their predation rates when they were exposed to other predators. Trait mediated interactions might be frequent in this system: for example, in close quarters of bromeliads it may be more likely that predators are aware of each other's densities. Physical touch and chemical cues can both be frequent cues for the presence of predators, and can trigger trait-mediated-effects. In bromeliads, a diverse community occurs at a very small spatial scale and diverse predators are quite likely to overlap.  Such predator-induced decreases in feeding might actually be common, although we would not estimate them directly by densities of predators [@Werner2003].

* Feeding differences between predators, combined with their patchy but unpredictable distribution among bromeliads, creates a large variation in food web structure and total amount of predation per patch within this bromeliad metacommunity 

Predators have different feeding rates, feed in different parts of the bromeliad, and have different effects on each other.  The presence of a predator with a low feeding rate may have a strong positive effect on prey survival, if it decreases the predation rate of _Leptagrion_ sp..  This uncouples predation rate and predator biomass, and creates a constantly changing amount of top-down regulation in this system.  These predators might also differ in dispersal rates, and in vulnerability to other predators.  for example, Leptagrion spp are frequent prey for semi-aquatic spiders, but tabanids are likely safe from most large predators because of their position deep in leaf axils.


* In response to predator manipulations we observed less transfer of Nitrogen into bromeliad tissue than did Ngai and Srivastava (2006); this may be due to a greater role for bacterial decomposition in this system (cite?).

Insects sometimes can be the major group which determines the speed of decomposition.  However, when substrate is very recalcitrant the insects are only able to break down small amounts of detritus.  In restingas, the leaves are very thick and waxy, a possible adaptation to the poor growing conditions.  As a result, invertebrates in this system do not eat the leaves directly; rather microinverterbrates (zooplankton) and bacteria do most of the decomposition.  This hypothesis could be tested, for example, by performing bacterial community "transplants" from a host bromelid to a sterile bromeliad, which could then be monitored for a decomposition rate similar to the original bromeliad.  Ngai et al hypothesized that their increase in nutrient cycling that they observed was due to increased mortality of insects, and that bromeliads were absorbing N from odonate predator waste.  In our system, a more diverse predator community leaves different kinds of dead prey, and also different dead insects.  Tabanids are primarily sucking predators, which leave the integument of their prey behind.  The waste products of these different predators might also be very different, depending on the physiology and nutrient requirements and efficienty of each predator.  

Leaf decomposition does not show a strong relationship with bromeliad size in Cardoso, even though there is a strong relationship in Costa Rica (Robin)

It may be that different predators influence the composition of the detritus (animal, fecal and leaf), and that this bottom-up effect determines the success of different taxa, as well as rates of nutrient cycling.

## Supplementary

|  Species                 | density |
|:------------------------:|:-------:|
| *Chironomus detriticula* |  10     |
| *Polypedium sp. 1*       |  4      |
| *Polypedium sp. 2*       |  2      |
| *Psychodid sp. 1*        |  1      |
| *Scyrtes sp. A*          |  5      |
| *Culex spp.*             |  4      |
| *Trentepholia sp.*       |  1      |

  : Densities of insects used in the experiment.

-->

## References