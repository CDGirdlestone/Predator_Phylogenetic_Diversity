---
title: "Supplementary Material"
author: "A. Andrew M. MacDonald; Diane S. Srivastava; Gustavo Q. Romero"
output:
  pdf_document: default
  md_document: default
  html_document: default
  word_document:
    reference_docx: reference.docx
bibliography: /home/andrew/Documents/Mendeley_reference_lists/@MS_pdpaper.bib
---

```{r packages_data, results='asis', echo=FALSE,message=FALSE}
library(magrittr)
library(dplyr)
library(pander)
library(picante)
library(stargazer)
library(tidyr)
library(knitr)
opts_chunk$set(message=FALSE,warning=FALSE,echo=FALSE,fig.cap=FALSE)
library(ggplot2)
mytheme <- theme_bw()

# experimental data
pd <- read.csv("../data/reorganized_data/pd_exp_cleaned_data.csv",
               stringsAsFactors=FALSE) %>%
  tbl_df() %>%
  transform(decomp=ifelse(decomp>0.7,NA,decomp))

predtree_timetree_ages <- read.tree("../data/reorganized_data/predator_tree_time.newick")

dist_sim <- read.csv(file = "distributional_similarity.csv")

diet_sim <- read.csv(file = "diet_similarity.csv")
```

### predator phylogeny



```{r}
predtree_timetree_ages %>% plot
```


### Model comparison for distributional similarity as a function of PD
```{r results='asis',echo=FALSE}
formulae <- c("quadratic" = "$a \\times (PD)^2 + b \\times PD + c$",
              "bellshaped" = "$peak \\times {e}^{(-1 \\times (PD)^2 / a)}$",
              "{e}^{onential" = "$b \\times {e}^{(a \\times PD)}$",
              "Sshaped" = "$\\frac{c \\times {e}^{(a \\times PD)}}{(c \\times {e}^{(a \\times PD)} + (1 - c))}$",
              "linear" = "$a \\times x + b$",
              "constant" = "a \\times x$"
              )

dist_sim %>%
  mutate(Equation = formulae[model]) %>%
  select(Equation,AIC) %>%
  pander
```

### Model comparison for diet similarity as a function of PD
Note: these models are weighted by the number of prey species tested
```{r results='asis',echo=FALSE}
diet_sim %>%
  mutate(Equation = formulae[model]) %>%
  select(Equation,AIC) %>%
  pander
```

## Predator diversity experiment

### Prey community composition
Densities of prey species used in the experiment.

|  Species                 | density |
|:------------------------:|:-------:|
| *Chironomus detriticula* |  10     |
| *Polypedium sp. 1*       |  4      |
| *Polypedium sp. 2*       |  2      |
| *Psychodid sp. 1*        |  1      |
| *Scyrtes sp. A*          |  5      |
| *Culex spp.*             |  4      |
| *Trentepholia sp.*       |  1      |

### experimental summary
```{r exp summary, results='asis'}
pd %>%
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  gather(response,value,-treatment) %>%
  group_by(treatment,response) %>%
  summarise(meanval=mean(value),
            n=n(),
            sdev=sd(value)) %>%
  mutate(SE=sdev/sqrt(n),
         meanval_sig=signif(meanval,2),
         SE_sig=signif(SE,2),
         meanSE=paste(meanval_sig,"Â±",SE_sig)) %>%
  select(treatment,response,meanSE) %>% 
  spread(response,meanSE) %>%
  stargazer(summary = FALSE, type = "latex", header = FALSE)

# # could rename with this
# coltext <- expression("surviving insects","fine detritus (g)","leaf decomposition (g)",
#                       "bromeliad growth (g)","Nitrogen cycling")
```

### the effect of predator diversity *per se*
```{r experimentANOVA,results='asis'}

trt_lkp <- c("andro" = "single",
             "tabanid" = "single",
             "elong + andro" = "pair",
             "control" = "control",
             "leech" = "single",
             "elong + leech" = "pair",
             "elong" = "single",
             "elong + tab" = "pair")

mean_na <- function(x) mean(x, na.rm = TRUE)

ctrl_single_pair <- pd %>% 
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(treatment = treatment %>% 
           equals("control") %>% 
           ifelse(paste0(treatment,seq_along(treatment)),
                  treatment)) %>%
  group_by(treatment) %>%
  summarise_each(funs(mean_na)) %>%
  mutate(treatment = treatment %>% gsub("\\d","",.),
         treatment = trt_lkp[treatment],
         treatment = treatment %>% ordered(x = .,levels = c("control","single","pair"))) %>%
  gather(resp,val,-treatment)
# 
# ctrl_single_pair %>% 
#   ggplot(aes(x = treatment


ctrl_single_pair_lm <- ctrl_single_pair %>% 
  group_by(resp) %>%
  do(anova_ord = aov(val ~ treatment, data = .)) %>%
  function(g) {
    g %>% 
      extract2("anova_ord") %>% 
      set_names(g %>% extract2("resp"))
    }

lapply(ctrl_single_pair_lm,TukeyHSD) %>%
  lapply(function(x) x[["treatment"]]) %>%
  lapply(as.data.frame) %>%
  lapply(function(x) data.frame(comparison = row.names(x),x)) %>%
  function(m) {
    comps <- rbind_all(m)
    r <- names(m) %>% rep(times = sapply(m,nrow) %>% as.numeric)
    data.frame(r,comps)
    } %>%
  stargazer(header = FALSE, summary = FALSE)


### calculate treatment means?
trtmeans  <- pd %>% 
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(treatment = treatment %>% 
           equals("control") %>% 
           ifelse(paste0(treatment,seq_along(treatment)),
                  treatment)) %>%
  group_by(treatment) %>%
  summarise_each(funs(mean_na)) %>%
  mutate(treatment = treatment %>% gsub("\\d","",.),
         treatment = trt_lkp[treatment],
         treatment = treatment %>% ordered(x = .,levels = c("control","single","pair"))) %>%
  gather(resp,val,-treatment) %>% 
  group_by(resp,treatment) %>%
  mutate(meanval = mean(val)) 

# %>%
#   ggplot(aes(x = treatment, y = val)) + 
#   geom_point(position = "jitter") + 
#   scale_shape(solid=FALSE) #+ 
#   #facet_wrap(~resp, scales = "free")

```

## single-species work
```{r TEST_experiment_single_pred, results='asis'}

singlepred <- pd %>%
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(trt_type = trt_lkp[treatment]) %>%
  filter(trt_type == "single") 

singlepred_resp <- vector("list",5) %>%
  set_names(singlepred %>% select(total.surv:N) %>% names)

singlepred_resp$total.surv  <- glm(total.surv ~ treatment,
                                   family = "poisson",data = singlepred)
singlepred_resp$fine <- lm(fine ~ treatment, data = singlepred)
singlepred_resp$decomp <- lm(decomp ~ treatment, data = singlepred)
singlepred_resp$growth <- lm(growth ~ treatment, data = singlepred)
singlepred_resp$N <- lm(N ~ treatment, data = singlepred)
  
## models
stargazer(singlepred_resp, header = FALSE)

## CI
preds <- lapply(singlepred_resp,function(x) {
  treatment = c("andro","tabanid","leech","elong")
  preds <- predict(x,newdata = data.frame(treatment),
                   interval = "confidence")
  data.frame(treatment,preds)}) %>%
  plyr::ldply(.,) %>%
  select(treatment,response = .id,fit,lwr,upr) %>%
  arrange(treatment) %>%
  mutate(treatment = as.character(treatment)) %>%
  tbl_df

## graph
experiment <- singlepred %>%
  tbl_df %>%
  select(-trt_type) %>%
  gather(response, value, total.surv:N) %>%
  group_by(treatment, response) %>%
  summarise(resp.mean = mean(value, na.rm = TRUE),
            resp.n = n(),
            se = sd(value, na.rm = TRUE)/sqrt(resp.n),
            ci_lo = resp.mean - 1.96 * se,
            ci_hi = resp.mean + 1.96 * se) %>% 
  ungroup()

left_join(preds,experiment) %>%
  ggplot(aes(x = treatment, y = resp.mean)) + 
  geom_point(size=6,shape = 21, colour = "black", fill = "#00A08A") + 
  ylab("Mean response") + 
  geom_linerange(aes(ymin = resp.mean - se, ymax = resp.mean + se)) +
  facet_wrap(~response, scales = "free") + mytheme
```

```{r}
left_join(preds,experiment) %>%
  filter(response != "total.surv") %>%
  ggplot(aes(x = treatment, y = fit)) + 
  geom_point(size=6,shape = 21, colour = "black", fill = "#00A08A") + 
  ylab("Mean response") + 
  geom_linerange(aes(ymin = lwr, ymax = upr)) +
  facet_wrap(~response, scales = "free") + mytheme

```

#### confidence intervals
```{r results='asis'}
## anovas and TukeyHSDs
singlepred_resp_aov <- vector("list",4) %>%
  set_names(singlepred %>% select(fine:N) %>% names)

singlepred_resp_aov$fine <- aov(fine ~ treatment, data = singlepred)
singlepred_resp_aov$decomp <- aov(decomp ~ treatment, data = singlepred)
singlepred_resp_aov$growth <- aov(growth ~ treatment, data = singlepred)
singlepred_resp_aov$N <- aov(N ~ treatment, data = singlepred) 

tukies <- lapply(singlepred_resp_aov,TukeyHSD)

trts <- lapply(tukies,function(x) x$treatment)
```



#### fine detritus
```{r results='asis'}
stargazer(trts$fine, header = FALSE)
```



#### decomposition


```{r results='asis'}
stargazer(trts$decomp, header = FALSE)
```



#### growth
```{r results='asis'}
stargazer(trts$growth, header = FALSE)
```



#### N
```{r results='asis'}
stargazer(trts$N, header = FALSE)
```

