---
title: "Supplementary Material"
author: "A. Andrew M. MacDonald; Diane S. Srivastava; Gustavo Q. Romero"
output:
  pdf_document: default
  md_document: default
  html_document: default
  word_document:
    reference_docx: reference.docx
bibliography: /home/andrew/Documents/Mendeley_reference_lists/@MS_pdpaper.bib
---


```{r packages_data, results='asis', echo=FALSE,message=FALSE}
library(magrittr)
library(dplyr)
library(pander)
library(picante)
library(stargazer)
library(xtable)
library(tidyr)
library(knitr)
opts_chunk$set(message=FALSE,warning=FALSE,echo=FALSE)
library(ggplot2)
mytheme <- theme_bw()

# experimental data
pd <- read.csv("../data/reorganized_data/pd_exp_cleaned_data.csv",
               stringsAsFactors=FALSE) %>%
  tbl_df() %>%
  transform(decomp=ifelse(decomp>0.7,NA,decomp))

predtree_timetree_ages <- read.tree("../data/reorganized_data/predator_tree_time.newick")

dist_sim <- read.csv(file = "distributional_similarity.csv")

diet_sim <- read.csv(file = "diet_similarity.csv")

prop.eaten <- read.csv(file = "proportion.eaten.csv")

timetree <- list.files("../data/TreeData/", full.names = TRUE, pattern = "*.csv") %>%
  function(d) {basename(d) %>% gsub(".csv","",.) %>% set_names(d,.)} %>%
  lapply(read.csv,stringsAsFactors = FALSE) %>%
  plyr::ldply() %>%
  mutate(foo = seq_along(Taxon.A)) %>%
  gather(var,val,-foo) %>%
  mutate(val = gsub("\\(.+\\)","", val)) %>%
  spread(var,val) %>%
  select(-foo,"study taxa" = .id,Time:Year)

```

# Predator phylogeny

We used information from timetree.org (link) to add node ages to our tree.  This web service provides age estimates from the literature for all pairs of taxa from the same groups as the searched taxa. Thus deeper nodes are estimated from more taxa than shallower nodes, because more species are included among the descendents.  

**Table S1** Studies used to date nodes on our predator phylogeny.  When more than one study was available, we used the median value.  

```{r TABLE_Timetree, results='asis'}
xtable(timetree) %>% print(include.rownames = FALSE, size = 8, comment = FALSE)
```

```{r FIG_predatorphylo}
predtree_timetree_ages %>% plot
```

**Figure S1** Predator phylogeny, with dated nodes derived from data in Table 1.  When multiple time estimates are available, we used the median.


# Phylogenetic distance and similarity in distribution and diet: nonlinear models

Similarity in distribution or diet might not be similar over time, but might in fact relate to the increased amount or the plateauing of variation after a certain amount of evolutionary time. Additionally, because our similarity measure is bouded by 0 and 1, fitting a linear relationship may lead to nonsensical predicted values. 

## Distributional similarity

**Table S2** Linear, nonlinear and constant functions fit to the relationship of diet similarity and predator phylogenetic distance.
```{r TABLE_dietsim, results='asis',echo=FALSE}
formulae <- c("quadratic" = "$a \\times (PD)^2 + b \\times PD + c$",
              "bellshaped" = "$peak \\times {e}^{(-1 \\times (PD)^2 / a)}$",
              "{e}^{onential" = "$b \\times {e}^{(a \\times PD)}$",
              "Sshaped" = "$\\frac{c \\times {e}^{(a \\times PD)}}{(c \\times {e}^{(a \\times PD)} + (1 - c))}$",
              "linear" = "$a \\times x + b$",
              "constant" = "a \\times x$"
              )

dist_sim %>%
  mutate(Equation = formulae[model]) %>%
  select(Equation,AIC) %>%
  pander
```

## Diet similarity

**Table S3** proportion of predation in the feeding trials. 
```{r prop.eaten.table, results='asis'}
preds <- c("leech","L.andro","L.elong","L.tan","Monopelopia","Tab.A","Tab.B","Tab.C") %>%
  set_names(c("Hirudinidae","Leptagrion.andromache","Leptagrion.elongatum","Leptagrion.tan","Monopelopia","Tabanidae.spA","Tabanidae.spB","Tabanidae.spC"))

prop.eaten %>% 
  select(-X) %>%
  mutate(predator.names = predator.names %>% as.character %>% preds[.]) %>%
  data.frame(row.names = "predator.names") %>% 
  t %>% 
  signif(digits = 2) %>%
  function(mat) mat[mat %>% is.na %>% rowSums %>% order,
                    mat %>% is.na %>% colSums %>% order] %>%
  xtable %>%
  print(include.rownames = TRUE, size = 5, comment = FALSE)
```


**Table S3** Linear, nonlinear and constant functions fit to the relationship of diet similarity and predator phylogenetic distance. These models are weighted by the number of prey species tested
```{r results='asis',echo=FALSE}
diet_sim %>%
  mutate(Equation = formulae[model]) %>%
  select(Equation,AIC) %>%
  pander
```

# Predator diversity experiment

## Prey community composition 

We estimated the densities of these common prey species based on their abundances in our 2008 observational dataset as a function of bromeliad size.  We adjusted our density estimates slightly to account for interannual variation in invertebrate abundance.

**Table S4** Densities of prey species used in the experiment.

|  Species                 | density |
|:------------------------:|:-------:|
| *Chironomus detriticula* |  10     |
| *Polypedium sp. 1*       |  4      |
| *Polypedium sp. 2*       |  2      |
| *Psychodid sp. 1*        |  1      |
| *Scyrtes sp. A*          |  5      |
| *Culex spp.*             |  4      |
| *Trentepholia sp.*       |  1      |

## experimental responses 

We calculated means and standard error for every experimental treatment and response variable.  n = 5 for every pair of numbers, with only two exceptions due to missing values: `elong + leech` x `growth`, and `leech` x `decomp`.

**Table S5**: Means and standard errors for all response variables for each predator treatment in our manipulative experiment.
```{r exp summary, results='asis'}
pd %>%
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  gather(response,value,-treatment) %>%
  filter(!is.na(value)) %>%
  group_by(treatment,response) %>%
  summarise(meanval=mean(value),
            n=n(),
            sdev=sd(value)) %>%
  mutate(SE=sdev/sqrt(n),
         meanval_sig=signif(meanval,2),
         SE_sig=signif(SE,2),
         meanSE=paste(meanval_sig,"Â±",SE_sig)) %>%
  select(treatment,response,meanSE) %>% 
  spread(response,meanSE) %>%
  xtable %>% 
  print(include.rownames = FALSE, size = 8, comment = FALSE)
#   stargazer(summary = FALSE, type = "latex", header = FALSE, 
#             dep.var.caption = "", notes.label = "")

# # could rename with this
# coltext <- expression("surviving insects","fine detritus (g)","leaf decomposition (g)",
#                       "bromeliad growth (g)","Nitrogen cycling")
```

## Differences among treatments

### Number of predator species

Our experimental design manipulates predator diversity at three levels, and we tested each in turn.  At the highest level, we introduced zero, one and two species of predators into different bromeliads.  

**Table S6**: Number of predator species in each experimental treatment.
```{r experimentANOVA,results='asis'}

trt_lkp <- c("andro" = "one",
             "tabanid" = "one",
             "elong + andro" = "two",
             "control" = "none",
             "leech" = "one",
             "elong + leech" = "two",
             "elong" = "one",
             "elong + tab" = "two")

data.frame(Nspp = factor(trt_lkp, levels = c("none",
                                             "one",
                                             "two")),
           treatment = names(trt_lkp)) %>%
  arrange(Nspp) %>%
  xtable %>% 
  print(include.rownames = FALSE, size = 8, comment = FALSE)
```

**Table S7**: the effect of predator species number on all 5 response variables.  We used ordinal contrasts to investigate how changing number of predator species changed the response.  Treatment order was none < one < two species. (See Table S6).
```{r results='asis'}
mean_na <- function(x) mean(x, na.rm = TRUE)

## average every treatment 
ctrl_single_pair <- pd %>% 
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(treatment = treatment %>% 
           equals("control") %>% 
           ifelse(paste0(treatment,
                         seq_along(treatment)),
                  treatment)) %>%
  group_by(treatment) %>%
  summarise_each(funs(mean_na)) %>%
  mutate(treatment = treatment %>% gsub("\\d","",.),
         treatment = trt_lkp[treatment],
         treatment = treatment %>% ordered(x = .,levels = c("none","one","two"))) %>%
  gather(resp,val,-treatment)

## linear models
ctrl_single_pair_lm <- ctrl_single_pair %>% 
  group_by(resp) %>%
  do(anova_ord = lm(val ~ treatment, data = .)) %>%
  function(df) split(df$anova_ord,df$resp) %>%
  lapply(function(x) x[[1]])

## present table
stargazer(ctrl_single_pair_lm,label = "",
          dep.var.labels = names(ctrl_single_pair_lm),
          header = FALSE, multicolumn = FALSE)
```


```{r FIG_spp_number}
trtnames <- c("total.surv" = "Total prey survival",
  "fine" = "FPOM (g)",
  "decomp" = "Decomposition (g)",
  "growth" = "Bromeliad growth",
  "N" = "Nitrogen cycling")

ctrl_single_pair %>% 
  mutate(resp = as.character(resp)) %>%
  mutate(resp = trtnames[resp]) %>%
  group_by(treatment,resp) %>%
  mutate(trtmean = mean(val)) %>%
  ggplot(aes(x = treatment, y = val)) + 
  geom_point(aes(y = trtmean),size = 4, shape = 21, 
             colour = "black", fill = "#00A08A") +
  geom_point(shape = 21, fill = NA, size = 4) + 
  facet_wrap(~resp,scales = "free") +
  ylab("response") +
  xlab("Predator species number") + 
  mytheme
```
**Figure S1**: The effect of predator species number on each of our response variables.  Each dot represents the mean for a different predator treatment.  Green dots represent group means.  



```{r results='asis'}

ctrl_single_pair %>% 
  group_by(resp) %>%
  do(anova_ord = aov(val ~ treatment, data = .)) %>%
  function(g) {
    g %>% 
      extract2("anova_ord") %>% 
      set_names(g %>% extract2("resp"))
    } %>%
  lapply(TukeyHSD) %>%
  lapply(function(x) x[["treatment"]]) %>%
  lapply(as.data.frame) %>%
  lapply(function(x) data.frame(comparison = row.names(x),x)) %>%
  function(m) {
    comps <- rbind_all(m)
    r <- names(m) %>% rep(times = sapply(m,nrow) %>% as.numeric)
    data.frame(r,comps)
    } %>% 
  select(response = r, comparison:p.adj) %>%
  xtable %>% 
  print(include.rownames = FALSE, size = 8, comment = FALSE)
#   stargazer(header = FALSE, summary = FALSE)


### calculate treatment means?
trtmeans  <- pd %>% 
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(treatment = treatment %>% 
           equals("control") %>% 
           ifelse(paste0(treatment,seq_along(treatment)),
                  treatment)) %>%
  group_by(treatment) %>%
  summarise_each(funs(mean_na)) %>%
  mutate(treatment = treatment %>% gsub("\\d","",.),
         treatment = trt_lkp[treatment],
         treatment = treatment %>% ordered(x = .,levels = c("control","single","pair"))) %>%
  gather(resp,val,-treatment) %>% 
  group_by(resp,treatment) %>%
  mutate(meanval = mean(val)) 

```

## single-species work
```{r TEST_experiment_single_pred, results='asis'}

singlepred <- pd %>%
  select(treatment,total.surv,fine,decomp,growth,N) %>%
  mutate(trt_type = trt_lkp[treatment]) %>%
  filter(trt_type == "one") 

singlepred_resp <- vector("list",5) %>%
  set_names(singlepred %>% select(total.surv:N) %>% names)

singlepred_resp$total.surv  <- glm(total.surv ~ treatment,
                                   family = "poisson",data = singlepred)
singlepred_resp$fine <- lm(fine ~ treatment, data = singlepred)
singlepred_resp$decomp <- lm(decomp ~ treatment, data = singlepred)
singlepred_resp$growth <- lm(growth ~ treatment, data = singlepred)
singlepred_resp$N <- lm(N ~ treatment, data = singlepred)
  
## models
stargazer(singlepred_resp, header = FALSE)

## CI
preds <- lapply(singlepred_resp,function(x) {
  treatment = c("andro","tabanid","leech","elong")
  preds <- predict(x,newdata = data.frame(treatment),
                   interval = "confidence")
  data.frame(treatment,preds)}) %>%
  plyr::ldply(.,) %>%
  select(treatment,response = .id,fit,lwr,upr) %>%
  arrange(treatment) %>%
  mutate(treatment = as.character(treatment)) %>%
  tbl_df

## graph
experiment <- singlepred %>%
  tbl_df %>%
  select(-trt_type) %>%
  gather(response, value, total.surv:N) %>%
  group_by(treatment, response) %>%
  summarise(resp.mean = mean(value, na.rm = TRUE),
            resp.n = n(),
            se = sd(value, na.rm = TRUE)/sqrt(resp.n),
            ci_lo = resp.mean - 1.96 * se,
            ci_hi = resp.mean + 1.96 * se) %>% 
  ungroup()

left_join(preds,experiment) %>%
  ggplot(aes(x = treatment, y = resp.mean)) + 
  geom_point(size=6,shape = 21, colour = "black", fill = "#00A08A") + 
  ylab("Mean response") + 
  geom_linerange(aes(ymin = resp.mean - se, ymax = resp.mean + se)) +
  facet_wrap(~response, scales = "free") + mytheme
```

```{r}
left_join(preds,experiment) %>%
  filter(response != "total.surv") %>%
  ggplot(aes(x = treatment, y = fit)) + 
  geom_point(size=6,shape = 21, colour = "black", fill = "#00A08A") + 
  ylab("Mean response") + 
  geom_linerange(aes(ymin = lwr, ymax = upr)) +
  facet_wrap(~response, scales = "free") + mytheme

```

#### confidence intervals
```{r results='asis'}
## anovas and TukeyHSDs
singlepred_resp_aov <- vector("list",4) %>%
  set_names(singlepred %>% select(fine:N) %>% names)

singlepred_resp_aov$fine <- aov(fine ~ treatment, data = singlepred)
singlepred_resp_aov$decomp <- aov(decomp ~ treatment, data = singlepred)
singlepred_resp_aov$growth <- aov(growth ~ treatment, data = singlepred)
singlepred_resp_aov$N <- aov(N ~ treatment, data = singlepred) 

tukies <- lapply(singlepred_resp_aov,TukeyHSD)

trts <- lapply(tukies,function(x) x$treatment)
```



#### fine detritus
```{r results='asis'}
stargazer(trts$fine, header = FALSE)
```



#### decomposition


```{r results='asis'}
stargazer(trts$decomp, header = FALSE)
```



#### growth
```{r results='asis'}
stargazer(trts$growth, header = FALSE)
```



#### N
```{r results='asis'}
stargazer(trts$N, header = FALSE)
```

